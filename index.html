<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–î–µ—Ç–∞–ª–∏ –≥–æ—Ä–æ–¥–∞ ‚Äî –¢—É–ª–∞</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#ffffff">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="–î–µ—Ç–∞–ª–∏ –≥–æ—Ä–æ–¥–∞">
  <link rel="apple-touch-icon" href="icon-192.png">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@300;400;500&family=IBM+Plex+Sans:wght@300;400;500;600&display=swap">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'IBM Plex Sans', sans-serif; background: #ffffff; color: #1a1a1a; overflow: hidden; }
    #map { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 1; }
    .leaflet-tile { filter: grayscale(1) brightness(1.1) contrast(0.85); }
    .leaflet-control-attribution { font-size: 9px !important; opacity: 0.4; background: rgba(255,255,255,0.7) !important; }
    .leaflet-control-zoom { border: none !important; }
    .leaflet-control-zoom a { background: #ffffff !important; color: #999 !important; border: 1px solid #e0e0e0 !important; width: 32px !important; height: 32px !important; line-height: 32px !important; font-size: 16px !important; box-shadow: 0 2px 8px rgba(0,0,0,0.08) !important; }
    .leaflet-control-zoom a:hover { background: #f5f5f5 !important; color: #333 !important; }

    .site-header { position: fixed; top: 20px; left: 20px; z-index: 900; pointer-events: none; }
    .site-header h1 { font-family: 'IBM Plex Mono', monospace; font-weight: 400; font-size: 14px; letter-spacing: 0.15em; color: #999; line-height: 1.3; }

    .admin-button { position: fixed; top: 20px; right: 20px; z-index: 900; width: 40px; height: 40px; border-radius: 50%; background: #ffffff; color: #999; border: 1px solid #e0e0e0; font-size: 18px; cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 12px rgba(0,0,0,0.08); display: flex; align-items: center; justify-content: center; }
    .admin-button:hover { color: #333; border-color: #999; box-shadow: 0 4px 16px rgba(0,0,0,0.12); }
    .admin-button.active { background: #1a1a1a; color: #fff; border-color: #1a1a1a; }
    .badge { position: absolute; top: -4px; right: -4px; background: #cd5c5c; color: #fff; font-size: 10px; font-weight: 600; min-width: 18px; height: 18px; border-radius: 9px; display: flex; align-items: center; justify-content: center; font-family: 'IBM Plex Mono', monospace; }
    .badge.hidden { display: none; }

    .geo-button { position: fixed; top: 70px; right: 20px; z-index: 900; width: 40px; height: 40px; border-radius: 50%; background: #ffffff; color: #999; border: 1px solid #e0e0e0; font-size: 18px; cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 12px rgba(0,0,0,0.08); display: flex; align-items: center; justify-content: center; }
    .geo-button:hover { color: #333; border-color: #999; }
    .geo-button.locating { animation: geoPulse 1s ease infinite; }
    @keyframes geoPulse { 0%,100% { background: #fff; } 50% { background: #e3f2fd; } }

    .detail-marker { width: 38px; height: 38px; border-radius: 50%; border: 3px solid #1a1a1a; cursor: pointer; background-size: cover; background-position: center; background-color: #f0f0f0; transition: transform 0.2s, box-shadow 0.2s; box-shadow: 0 2px 12px rgba(0,0,0,0.12); }
    .detail-marker:hover { transform: scale(1.4); box-shadow: 0 4px 24px rgba(0,0,0,0.2); }
    .detail-marker[data-category="texture"] { border-color: #b8860b; }
    .detail-marker[data-category="sign"] { border-color: #2e8b57; }
    .detail-marker[data-category="art"] { border-color: #e91e63; }
    .detail-marker[data-category="detail"] { border-color: #4169e1; }
    .detail-marker[data-category="other"] { border-color: #999; }
    .detail-marker.pending { opacity: 0.5; border-style: dashed; }

    .temp-marker { width: 22px; height: 22px; border-radius: 50%; background: #1a1a1a; border: 3px solid #ffffff; box-shadow: 0 0 0 2px #1a1a1a, 0 4px 16px rgba(0,0,0,0.3); animation: pulse 1.5s ease infinite; }
    @keyframes pulse { 0%, 100% { box-shadow: 0 0 0 2px #1a1a1a, 0 4px 8px rgba(0,0,0,0.2); } 50% { box-shadow: 0 0 0 2px #1a1a1a, 0 4px 24px rgba(0,0,0,0.4); } }

    .user-marker { width: 16px; height: 16px; border-radius: 50%; background: #4285f4; border: 3px solid #ffffff; box-shadow: 0 0 0 2px #4285f4, 0 2px 8px rgba(66,133,244,0.4); }

    .filters-bar { position: fixed; top: 16px; left: 50%; transform: translateX(-50%); display: flex; gap: 4px; background: #ffffff; border: 1px solid #e8e8e8; border-radius: 24px; padding: 4px; z-index: 890; box-shadow: 0 2px 12px rgba(0,0,0,0.06); }
    .filter-btn { padding: 7px 14px; border: none; background: none; color: #999; font-size: 12px; font-family: 'IBM Plex Mono', monospace; border-radius: 20px; cursor: pointer; transition: all 0.2s; white-space: nowrap; }
    .filter-btn:hover { color: #333; }
    .filter-btn.active { background: #1a1a1a; color: #ffffff; }

    .panel { position: fixed; bottom: 0; left: 0; right: 0; background: #ffffff; border-top: 1px solid #e8e8e8; z-index: 950; max-height: 70vh; overflow-y: auto; transform: translateY(0); transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1); box-shadow: 0 -4px 24px rgba(0,0,0,0.08); }
    .panel.hidden { transform: translateY(100%); pointer-events: none; }
    .close-btn { position: absolute; top: 12px; right: 16px; background: none; border: none; color: #999; font-size: 28px; cursor: pointer; z-index: 10; }
    .close-btn:hover { color: #333; }
    .panel-content { display: flex; gap: 24px; padding: 24px; max-width: 900px; margin: 0 auto; }
    #detail-photo { width: 300px; height: 300px; object-fit: cover; border-radius: 6px; flex-shrink: 0; background: #f5f5f5; }
    .detail-info { display: flex; flex-direction: column; gap: 12px; padding-top: 8px; }
    .detail-info h2 { font-family: 'IBM Plex Mono', monospace; font-weight: 500; font-size: 20px; color: #1a1a1a; }
    .detail-info p { color: #666; line-height: 1.7; font-size: 14px; }
    .detail-meta { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    .detail-sub { font-size: 12px; color: #aaa; font-family: 'IBM Plex Mono', monospace; }
    .detail-actions { display: flex; gap: 8px; margin-top: 8px; }
    .category-tag { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 11px; font-family: 'IBM Plex Mono', monospace; text-transform: uppercase; letter-spacing: 0.05em; border: 1px solid #1a1a1a; color: #1a1a1a; }
    .status-tag { display: inline-block; padding: 4px 10px; border-radius: 20px; font-size: 10px; font-family: 'IBM Plex Mono', monospace; text-transform: uppercase; }
    .status-tag.approved { background: #e8f5e9; color: #2e7d32; }
    .status-tag.pending { background: #fff3e0; color: #e65100; }
    .btn-approve { padding: 8px 16px; background: none; border: 1px solid #e0e0e0; color: #2e8b57; border-radius: 6px; font-size: 13px; cursor: pointer; font-family: 'IBM Plex Mono', monospace; transition: all 0.2s; }
    .btn-approve:hover { background: #2e8b57; color: #fff; border-color: #2e8b57; }
    .btn-delete { padding: 8px 16px; background: none; border: 1px solid #e0e0e0; color: #cd5c5c; border-radius: 6px; font-size: 13px; cursor: pointer; font-family: 'IBM Plex Mono', monospace; transition: all 0.2s; }
    .btn-delete:hover { background: #cd5c5c; color: #fff; border-color: #cd5c5c; }
    .admin-only { display: none; }
    body.admin-mode .admin-only { display: flex; }

    .add-button { position: fixed; bottom: 24px; right: 24px; z-index: 960; width: 52px; height: 52px; border-radius: 50%; background: #1a1a1a; border: none; color: #ffffff; font-size: 28px; cursor: pointer; transition: all 0.2s; box-shadow: 0 4px 16px rgba(0,0,0,0.15); display: flex; align-items: center; justify-content: center; }
    .add-button:hover { background: #333; transform: scale(1.1); }
    .add-button.hidden { display: none; }

    .add-panel { position: fixed; top: 0; right: 0; width: 380px; height: 100vh; background: #ffffff; border-left: 1px solid #e8e8e8; z-index: 950; overflow-y: auto; padding: 28px; transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1); box-shadow: -4px 0 24px rgba(0,0,0,0.06); }
    .add-panel.open { transform: translateX(0); }
    .add-panel h2 { font-family: 'IBM Plex Mono', monospace; font-weight: 500; margin-bottom: 16px; font-size: 18px; }
    .status-box { font-size: 13px; padding: 10px 14px; border-radius: 6px; margin-bottom: 20px; border-left: 3px solid; }
    .status-waiting { color: #b8860b; background: rgba(184,134,11,0.06); border-left-color: #b8860b; }
    .status-ready { color: #2e8b57; background: rgba(46,139,87,0.06); border-left-color: #2e8b57; }
    .form-field { margin-bottom: 16px; }
    .form-field label { display: block; font-size: 11px; font-family: 'IBM Plex Mono', monospace; text-transform: uppercase; letter-spacing: 0.08em; color: #999; margin-bottom: 6px; }
    .form-field input[type="text"], .form-field textarea, .form-field select { width: 100%; padding: 10px 12px; background: #fafafa; border: 1px solid #e0e0e0; border-radius: 6px; color: #1a1a1a; font-family: 'IBM Plex Sans', sans-serif; font-size: 14px; outline: none; }
    .form-field input:focus, .form-field textarea:focus, .form-field select:focus { border-color: #1a1a1a; }
    .form-field textarea { height: 80px; resize: vertical; }
    .form-field input[type="file"] { font-size: 13px; color: #999; }
    .photo-preview { margin-top: 8px; }
    .photo-preview img { max-width: 100%; max-height: 120px; border-radius: 6px; }
    .form-actions { display: flex; gap: 12px; margin-top: 24px; }
    .btn-primary { flex: 1; padding: 12px; background: #1a1a1a; color: #ffffff; border: none; border-radius: 6px; font-size: 14px; font-weight: 500; cursor: pointer; }
    .btn-primary:hover { background: #333; }
    .btn-secondary { flex: 1; padding: 12px; background: none; border: 1px solid #e0e0e0; color: #999; border-radius: 6px; font-size: 14px; cursor: pointer; }
    .btn-secondary:hover { border-color: #999; color: #666; }
    .map-hint { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); background: #1a1a1a; color: #ffffff; padding: 10px 20px; border-radius: 24px; font-size: 13px; font-family: 'IBM Plex Mono', monospace; z-index: 960; display: none; box-shadow: 0 4px 16px rgba(0,0,0,0.15); }
    .map-hint.visible { display: block; }

    .mod-panel { position: fixed; top: 0; right: 0; width: 420px; height: 100vh; background: #ffffff; border-left: 1px solid #e8e8e8; z-index: 970; overflow-y: auto; padding: 28px; transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1); box-shadow: -4px 0 24px rgba(0,0,0,0.06); }
    .mod-panel.open { transform: translateX(0); }
    .mod-panel h2 { font-family: 'IBM Plex Mono', monospace; font-weight: 500; font-size: 18px; margin-bottom: 8px; }
    .mod-subtitle { color: #999; font-size: 13px; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 1px solid #e8e8e8; }
    .mod-close { position: absolute; top: 16px; right: 16px; background: none; border: none; color: #999; font-size: 24px; cursor: pointer; }
    .mod-close:hover { color: #333; }
    .mod-card { background: #fafafa; border: 1px solid #e8e8e8; border-radius: 8px; padding: 16px; margin-bottom: 12px; }
    .mod-card-photo { width: 100%; height: 160px; object-fit: cover; border-radius: 4px; margin-bottom: 12px; }
    .mod-card h3 { font-family: 'IBM Plex Mono', monospace; font-weight: 500; font-size: 15px; margin-bottom: 4px; }
    .mod-card p { color: #666; font-size: 13px; line-height: 1.5; margin-bottom: 8px; }
    .mod-card-cat { font-size: 11px; color: #999; font-family: 'IBM Plex Mono', monospace; text-transform: uppercase; margin-bottom: 12px; }
    .mod-card-actions { display: flex; gap: 8px; }
    .mod-card-actions button { flex: 1; padding: 8px; border-radius: 4px; font-size: 13px; cursor: pointer; font-family: 'IBM Plex Mono', monospace; }
    .mod-btn-approve { background: #2e8b57; color: #fff; border: none; }
    .mod-btn-approve:hover { background: #236b43; }
    .mod-btn-reject { background: none; color: #cd5c5c; border: 1px solid #cd5c5c; }
    .mod-btn-reject:hover { background: #cd5c5c; color: #fff; }
    .mod-empty { text-align: center; padding: 40px 20px; color: #ccc; }
    .mod-empty-icon { font-size: 48px; margin-bottom: 12px; }

    .loading-overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: #fff; z-index: 9999; display: flex; align-items: center; justify-content: center; font-family: 'IBM Plex Mono', monospace; color: #999; font-size: 14px; }
    .loading-overlay.hidden { display: none; }

    @media (max-width: 768px) {
      .panel-content { flex-direction: column; padding: 20px; }
      #detail-photo { width: 100%; height: 220px; }
      .filters-bar { top: auto; bottom: 16px; overflow-x: auto; max-width: 92vw; left: 50%; transform: translateX(-50%); }
      .admin-button { top: 16px; right: 16px; width: 36px; height: 36px; font-size: 16px; }
      .geo-button { top: 60px; right: 16px; width: 36px; height: 36px; font-size: 16px; }
      .add-button { bottom: 72px; right: 24px; }
      .add-panel {
        width: 100%; height: auto; max-height: 120px; top: auto; bottom: 0; right: 0;
        border-left: none; border-top: 1px solid #e8e8e8; border-radius: 16px 16px 0 0;
        transform: translateY(100%); padding: 16px 20px; overflow: hidden;
        transition: max-height 0.4s cubic-bezier(0.16, 1, 0.3, 1), transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
      }
      .add-panel.open { transform: translateY(0); max-height: 120px; }
      .add-panel.open.expanded { max-height: 80vh; overflow-y: auto; }
      .add-panel h2 { font-size: 16px; margin-bottom: 8px; }
      .add-panel .form-field, .add-panel .form-actions { display: none; }
      .add-panel.expanded .form-field, .add-panel.expanded .form-actions { display: block; }
      .mod-panel { width: 100%; height: 70vh; top: auto; bottom: 0; right: 0; border-left: none; border-top: 1px solid #e8e8e8; border-radius: 16px 16px 0 0; transform: translateY(100%); }
      .mod-panel.open { transform: translateY(0); }
      .map-hint { bottom: 140px; font-size: 12px; padding: 8px 16px; }
    }
  </style>
</head>
<body>
  <div id="loading" class="loading-overlay">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
  <div id="map"></div>
  <div class="site-header"><h1>–î–ï–¢–ê–õ–ò<br>–ì–û–†–û–î–ê</h1></div>

  <button id="admin-btn" class="admin-button">‚öô<span id="pending-badge" class="badge hidden">0</span></button>
  <button id="geo-btn" class="geo-button">üìç</button>

  <div class="filters-bar">
    <button class="filter-btn active" data-filter="all">–í—Å–µ</button>
    <button class="filter-btn" data-filter="texture">–¢–µ–∫—Å—Ç—É—Ä—ã</button>
    <button class="filter-btn" data-filter="sign">–ó–Ω–∞–∫–∏</button>
    <button class="filter-btn" data-filter="art">–ê—Ä—Ç</button>
    <button class="filter-btn" data-filter="detail">–î–µ—Ç–∞–ª–∏</button>
    <button class="filter-btn" data-filter="other">–î—Ä—É–≥–æ–µ</button>
  </div>

  <div id="detail-panel" class="panel hidden">
    <button id="close-panel" class="close-btn">&times;</button>
    <div class="panel-content">
      <img id="detail-photo" src="" alt="">
      <div class="detail-info">
        <h2 id="detail-title"></h2>
        <p id="detail-description"></p>
        <div class="detail-meta">
          <span id="detail-category" class="category-tag"></span>
          <span id="detail-status" class="status-tag"></span>
        </div>
        <div id="detail-sub" class="detail-sub"></div>
        <div class="detail-actions admin-only">
          <button id="btn-approve-detail" class="btn-approve">‚úì –û–¥–æ–±—Ä–∏—Ç—å</button>
          <button id="btn-delete-detail" class="btn-delete">‚úï –£–¥–∞–ª–∏—Ç—å</button>
        </div>
      </div>
    </div>
  </div>

  <button id="add-btn" class="add-button">+</button>
  <div id="map-hint" class="map-hint">‚Üê –∫–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç—É —á—Ç–æ–±—ã –ø–æ—Å—Ç–∞–≤–∏—Ç—å —Ç–æ—á–∫—É</div>

  <div id="add-panel" class="add-panel">
    <h2>–ù–æ–≤–∞—è –¥–µ—Ç–∞–ª—å</h2>
    <div id="status-box" class="status-box status-waiting">‚Üê –ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç—É —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å –º–µ—Å—Ç–æ</div>
    <div class="form-field"><label>–§–æ—Ç–æ</label><input type="file" id="input-photo" accept="image/*"><div id="photo-preview" class="photo-preview"></div></div>
    <div class="form-field"><label>–ù–∞–∑–≤–∞–Ω–∏–µ</label><input type="text" id="input-title" placeholder="–°—Ç–∞—Ä–∏–Ω–Ω–∞—è —Ä–µ—à—ë—Ç–∫–∞ –Ω–∞ –ú–µ—Ç–∞–ª–ª–∏—Å—Ç–æ–≤"></div>
    <div class="form-field"><label>–û–ø–∏—Å–∞–Ω–∏–µ</label><textarea id="input-description" placeholder="–ß—Ç–æ –≤—ã –∑–∞–º–µ—Ç–∏–ª–∏?"></textarea></div>
    <div class="form-field"><label>–ê–≤—Ç–æ—Ä</label><input type="text" id="input-author" placeholder="–í–∞—à–µ –∏–º—è"></div>
    <div class="form-field"><label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
      <select id="input-category">
        <option value="texture">–¢–µ–∫—Å—Ç—É—Ä–∞</option>
        <option value="sign">–ó–Ω–∞–∫</option>
        <option value="art">–ê—Ä—Ç</option>
        <option value="detail">–î–µ—Ç–∞–ª—å</option>
        <option value="other">–î—Ä—É–≥–æ–µ</option>
      </select>
    </div>
    <div class="form-actions">
      <button id="submit-detail" class="btn-primary">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      <button id="cancel-form" class="btn-secondary">–û—Ç–º–µ–Ω–∞</button>
    </div>
  </div>

  <div id="mod-panel" class="mod-panel">
    <button id="mod-close" class="mod-close">&times;</button>
    <h2>–ú–æ–¥–µ—Ä–∞—Ü–∏—è</h2>
    <p class="mod-subtitle">–ù–æ–≤—ã–µ –∑–∞—è–≤–∫–∏ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</p>
    <div id="mod-list"></div>
  </div>
  <script>
    var SUPABASE_URL = 'https://yzvigrtnwmkwkpmqmdzh.supabase.co';
    var SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl6dmlncnRud21rd2twbXFtZHpoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA4MjQ0MTEsImV4cCI6MjA4NjQwMDQxMX0.Ky1RV2Lqd5TF4LzpQXJPuk2_HGLrXaKe6bBRm-niJ3c';
    var ADMIN_CODE = 'tula2024';
    var isAdmin = false;
    var CATEGORIES = {
      texture: { label: '–¢–µ–∫—Å—Ç—É—Ä–∞', color: '#b8860b' },
      sign: { label: '–ó–Ω–∞–∫', color: '#2e8b57' },
      art: { label: '–ê—Ä—Ç', color: '#e91e63' },
      detail: { label: '–î–µ—Ç–∞–ª—å', color: '#4169e1' },
      other: { label: '–î—Ä—É–≥–æ–µ', color: '#999999' }
    };
    var details = [], markerObjects = [], activeFilter = 'all';
    var isAddingMode = false, pendingCoords = null, tempMarker = null, currentDetailId = null, map;
    var userMarker = null;

    function supaFetch(path, options) {
      var opts = options || {};
      var headers = {
        'apikey': SUPABASE_KEY,
        'Authorization': 'Bearer ' + SUPABASE_KEY,
        'Content-Type': 'application/json',
        'Prefer': opts.prefer || 'return=representation'
      };
      return fetch(SUPABASE_URL + '/rest/v1/' + path, {
        method: opts.method || 'GET',
        headers: headers,
        body: opts.body ? JSON.stringify(opts.body) : undefined
      }).then(function(r) { return r.json(); });
    }

    function loadDetails() {
      var query = isAdmin ? 'details?select=*&order=created_at.desc' : 'details?select=*&status=eq.approved&order=created_at.desc';
      return supaFetch(query).then(function(data) {
        if (Array.isArray(data)) {
          details = data.map(function(d) {
            return { id: d.id, title: d.title, description: d.description || '', category: d.category, lat: d.lat, lng: d.lng, photo: d.photo_url || '', status: d.status, author: d.author || '', created_at: d.created_at || '' };
          });
        }
      }).catch(function(e) { console.error('Load error:', e); });
    }

    function loadAllForAdmin() {
      return supaFetch('details?select=*&order=created_at.desc').then(function(data) {
        if (Array.isArray(data)) {
          details = data.map(function(d) {
            return { id: d.id, title: d.title, description: d.description || '', category: d.category, lat: d.lat, lng: d.lng, photo: d.photo_url || '', status: d.status, author: d.author || '', created_at: d.created_at || '' };
          });
        }
      }).catch(function(e) { console.error('Load error:', e); });
    }

    function uploadPhoto(file) {
      var fileName = Date.now() + '_' + file.name.replace(/[^a-zA-Z0-9._-]/g, '');
      return fetch(SUPABASE_URL + '/storage/v1/object/photos/' + fileName, {
        method: 'POST',
        headers: {
          'apikey': SUPABASE_KEY,
          'Authorization': 'Bearer ' + SUPABASE_KEY,
          'Content-Type': file.type
        },
        body: file
      }).then(function(r) {
        if (r.ok) return SUPABASE_URL + '/storage/v1/object/public/photos/' + fileName;
        throw new Error('Upload failed');
      });
    }

    function formatDate(dateStr) {
      if (!dateStr) return '';
      var d = new Date(dateStr);
      var months = ['—è–Ω–≤', '—Ñ–µ–≤', '–º–∞—Ä', '–∞–ø—Ä', '–º–∞–π', '–∏—é–Ω', '–∏—é–ª', '–∞–≤–≥', '—Å–µ–Ω', '–æ–∫—Ç', '–Ω–æ—è', '–¥–µ–∫'];
      return d.getDate() + ' ' + months[d.getMonth()] + ' ' + d.getFullYear();
    }

    function getPendingCount() { return details.filter(function(d) { return d.status === 'pending'; }).length; }
    function updateBadge() {
      var c = getPendingCount(), b = document.getElementById('pending-badge');
      if (c > 0) { b.textContent = c; b.classList.remove('hidden'); } else { b.classList.add('hidden'); }
    }

    function geoLocate() {
      if (!navigator.geolocation) { alert('–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è'); return; }
      var btn = document.getElementById('geo-btn');
      btn.classList.add('locating');
      navigator.geolocation.getCurrentPosition(function(pos) {
        var lat = pos.coords.latitude, lng = pos.coords.longitude;
        map.flyTo([lat, lng], 17, { duration: 1.2 });
        if (userMarker) map.removeLayer(userMarker);
        userMarker = L.marker([lat, lng], {
          icon: L.divIcon({ html: '<div class="user-marker"></div>', className: '', iconSize: [16,16], iconAnchor: [8,8] })
        }).addTo(map);
        btn.classList.remove('locating');
      }, function(err) {
        btn.classList.remove('locating');
        if (err.code === 1) alert('–†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏');
        else alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ');
      }, { enableHighAccuracy: true, timeout: 10000 });
    }

    function initMap() {
      map = L.map('map', { center: [54.1935, 37.6180], zoom: 15, zoomControl: false });
      L.control.zoom({ position: 'bottomleft' }).addTo(map);
      L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { attribution: '¬© OpenStreetMap ¬© CARTO', maxZoom: 19 }).addTo(map);
      map.on('click', function(e) {
        if (!isAddingMode) return;
        pendingCoords = { lat: e.latlng.lat, lng: e.latlng.lng };
        if (tempMarker) map.removeLayer(tempMarker);
        tempMarker = L.marker([e.latlng.lat, e.latlng.lng], { icon: L.divIcon({ html: '<div class="temp-marker"></div>', className: '', iconSize: [22,22], iconAnchor: [11,11] }) }).addTo(map);
        var box = document.getElementById('status-box');
        box.className = 'status-box status-ready';
        box.textContent = '‚úì –ú–µ—Å—Ç–æ –≤—ã–±—Ä–∞–Ω–æ: ' + e.latlng.lat.toFixed(4) + ', ' + e.latlng.lng.toFixed(4);
        document.getElementById('add-panel').classList.add('expanded');
      });
    }

    function renderMarkers() {
      markerObjects.forEach(function(m) { map.removeLayer(m); }); markerObjects = [];
      details.filter(function(d) {
        if (!isAdmin && d.status !== 'approved') return false;
        if (activeFilter !== 'all' && d.category !== activeFilter) return false;
        return true;
      }).forEach(function(detail) {
        var cls = (detail.status === 'pending') ? ' pending' : '';
        var h = '<div class="detail-marker' + cls + '" data-category="' + detail.category + '"';
        if (detail.photo) h += ' style="background-image:url(' + detail.photo + ')"';
        h += '></div>';
        var marker = L.marker([detail.lat, detail.lng], { icon: L.divIcon({ html: h, className: '', iconSize: [38,38], iconAnchor: [19,19] }) }).addTo(map);
        marker.on('click', function() { if (isAddingMode) return; openDetail(detail); map.flyTo([detail.lat, detail.lng], 17, { duration: 0.8 }); });
        markerObjects.push(marker);
      });
    }

    function openDetail(d) {
      currentDetailId = d.id;
      document.getElementById('detail-photo').src = d.photo || '';
      document.getElementById('detail-photo').style.display = d.photo ? '' : 'none';
      document.getElementById('detail-title').textContent = d.title;
      document.getElementById('detail-description').textContent = d.description;
      var cat = CATEGORIES[d.category] || CATEGORIES.other;
      var tag = document.getElementById('detail-category');
      tag.textContent = cat.label; tag.style.borderColor = cat.color; tag.style.color = cat.color;
      var st = document.getElementById('detail-status');
      if (d.status === 'pending') { st.textContent = '–ù–∞ –º–æ–¥–µ—Ä–∞—Ü–∏–∏'; st.className = 'status-tag pending'; st.style.display = ''; }
      else if (isAdmin) { st.textContent = '–û–¥–æ–±—Ä–µ–Ω–æ'; st.className = 'status-tag approved'; st.style.display = ''; }
      else { st.style.display = 'none'; }
      var subParts = [];
      if (d.author) subParts.push(d.author);
      if (d.created_at) subParts.push(formatDate(d.created_at));
      document.getElementById('detail-sub').textContent = subParts.join(' ¬∑ ');
      document.getElementById('btn-approve-detail').style.display = (d.status === 'pending') ? '' : 'none';
      document.getElementById('detail-panel').classList.remove('hidden');
    }

    function closeDetail() { document.getElementById('detail-panel').classList.add('hidden'); currentDetailId = null; }

    function deleteDetail() {
      if (!currentDetailId || !confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –¥–µ—Ç–∞–ª—å?')) return;
      supaFetch('details?id=eq.' + currentDetailId, { method: 'DELETE', prefer: 'return=minimal' }).then(function() {
        details = details.filter(function(d) { return d.id !== currentDetailId; });
        renderMarkers(); closeDetail(); updateBadge(); renderModList();
      });
    }

    function approveDetail(id) {
      supaFetch('details?id=eq.' + id, { method: 'PATCH', body: { status: 'approved' } }).then(function() {
        var d = details.find(function(x) { return x.id === id; });
        if (d) { d.status = 'approved'; renderMarkers(); updateBadge(); renderModList(); if (currentDetailId === id) openDetail(d); }
      });
    }

    function rejectDetail(id) {
      if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞—è–≤–∫—É?')) return;
      supaFetch('details?id=eq.' + id, { method: 'DELETE', prefer: 'return=minimal' }).then(function() {
        details = details.filter(function(d) { return d.id !== id; });
        renderMarkers(); updateBadge(); renderModList();
        if (currentDetailId === id) closeDetail();
      });
    }

    function openAddForm() {
      isAddingMode = true;
      document.getElementById('add-panel').classList.add('open');
      document.getElementById('add-btn').classList.add('hidden');
      document.getElementById('map-hint').classList.add('visible');
      document.getElementById('map').style.cursor = 'crosshair';
      closeDetail(); closeModPanel();
    }

    function closeAddForm() {
      isAddingMode = false; pendingCoords = null;
      if (tempMarker) { map.removeLayer(tempMarker); tempMarker = null; }
      document.getElementById('add-panel').classList.remove('open');
      document.getElementById('add-panel').classList.remove('expanded');
      document.getElementById('add-btn').classList.remove('hidden');
      document.getElementById('map-hint').classList.remove('visible');
      document.getElementById('map').style.cursor = '';
      document.getElementById('input-title').value = '';
      document.getElementById('input-description').value = '';
      document.getElementById('input-author').value = '';
      document.getElementById('input-category').value = 'texture';
      document.getElementById('input-photo').value = '';
      document.getElementById('photo-preview').innerHTML = '';
      var box = document.getElementById('status-box');
      box.className = 'status-box status-waiting';
      box.textContent = '‚Üê –ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç—É —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å –º–µ—Å—Ç–æ';
    }

    function submitDetail() {
      var title = document.getElementById('input-title').value.trim();
      var desc = document.getElementById('input-description').value.trim();
      var author = document.getElementById('input-author').value.trim();
      var cat = document.getElementById('input-category').value;
      var fileInput = document.getElementById('input-photo');
      if (!title) { alert('–£–∫–∞–∂–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ'); return; }
      if (!pendingCoords) { alert('–ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç—É —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å –º–µ—Å—Ç–æ'); return; }
      var btn = document.getElementById('submit-detail');
      btn.disabled = true; btn.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞...';

      function saveToDb(photoUrl) {
        var row = { title: title, description: desc, category: cat, lat: pendingCoords.lat, lng: pendingCoords.lng, photo_url: photoUrl || '', status: isAdmin ? 'approved' : 'pending', author: author || '–ê–Ω–æ–Ω–∏–º' };
        supaFetch('details', { method: 'POST', body: row }).then(function(data) {
          if (data && data[0]) {
            var d = data[0];
            details.push({ id: d.id, title: d.title, description: d.description || '', category: d.category, lat: d.lat, lng: d.lng, photo: d.photo_url || '', status: d.status, author: d.author || '', created_at: d.created_at || '' });
          }
          renderMarkers(); closeAddForm(); updateBadge();
          btn.disabled = false; btn.textContent = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å';
          if (!isAdmin) alert('–°–ø–∞—Å–∏–±–æ! –í–∞—à–∞ –¥–µ—Ç–∞–ª—å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –Ω–∞ –º–æ–¥–µ—Ä–∞—Ü–∏—é.');
        }).catch(function(e) { alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è'); btn.disabled = false; btn.textContent = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å'; });
      }

      if (fileInput.files && fileInput.files[0]) {
        uploadPhoto(fileInput.files[0]).then(function(url) { saveToDb(url); }).catch(function() { saveToDb(''); });
      } else { saveToDb(''); }
    }

    function setFilter(f) {
      activeFilter = f;
      document.querySelectorAll('.filter-btn').forEach(function(b) { b.classList.toggle('active', b.dataset.filter === f); });
      renderMarkers();
    }

    function toggleAdmin() {
      if (isAdmin) { isAdmin = false; document.body.classList.remove('admin-mode'); document.getElementById('admin-btn').classList.remove('active'); closeModPanel(); loadDetails().then(function() { renderMarkers(); updateBadge(); }); return; }
      var code = prompt('–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞:');
      if (code === ADMIN_CODE) {
        isAdmin = true; document.body.classList.add('admin-mode'); document.getElementById('admin-btn').classList.add('active');
        loadAllForAdmin().then(function() { renderMarkers(); updateBadge(); if (getPendingCount() > 0) openModPanel(); });
      } else if (code !== null) alert('–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥');
    }

    function openModPanel() { document.getElementById('mod-panel').classList.add('open'); closeAddForm(); closeDetail(); renderModList(); }
    function closeModPanel() { document.getElementById('mod-panel').classList.remove('open'); }

    function renderModList() {
      var list = document.getElementById('mod-list');
      var pending = details.filter(function(d) { return d.status === 'pending'; });
      var exitBtn = '<button onclick="toggleAdmin()" style="width:100%;margin-top:20px;padding:12px;background:none;border:1px solid #e0e0e0;border-radius:6px;color:#999;font-size:13px;cursor:pointer;font-family:IBM Plex Mono,monospace;">–í—ã–π—Ç–∏ –∏–∑ –∞–¥–º–∏–Ω–∫–∏</button>';
      if (pending.length === 0) { list.innerHTML = '<div class="mod-empty"><div class="mod-empty-icon">‚úì</div><p>–ù–µ—Ç –∑–∞—è–≤–æ–∫ –Ω–∞ –º–æ–¥–µ—Ä–∞—Ü–∏–∏</p></div>' + exitBtn; return; }
      var html = '';
      pending.forEach(function(d) {
        var cat = CATEGORIES[d.category] || CATEGORIES.other;
        html += '<div class="mod-card">';
        if (d.photo) html += '<img class="mod-card-photo" src="' + d.photo + '" alt="">';
        html += '<h3>' + d.title + '</h3>';
        if (d.description) html += '<p>' + d.description + '</p>';
        html += '<div class="mod-card-cat">' + cat.label + ' ¬∑ ' + (d.author || '–ê–Ω–æ–Ω–∏–º') + ' ¬∑ ' + formatDate(d.created_at) + '</div>';
        html += '<div class="mod-card-actions"><button class="mod-btn-approve" onclick="approveDetail(\'' + d.id + '\')">‚úì –û–¥–æ–±—Ä–∏—Ç—å</button><button class="mod-btn-reject" onclick="rejectDetail(\'' + d.id + '\')">‚úï –û—Ç–∫–ª–æ–Ω–∏—Ç—å</button></div></div>';
      });
      list.innerHTML = html + exitBtn;
    }

    function initEvents() {
      document.getElementById('close-panel').addEventListener('click', closeDetail);
      document.getElementById('add-btn').addEventListener('click', openAddForm);
      document.getElementById('cancel-form').addEventListener('click', closeAddForm);
      document.getElementById('submit-detail').addEventListener('click', submitDetail);
      document.getElementById('btn-delete-detail').addEventListener('click', deleteDetail);
      document.getElementById('btn-approve-detail').addEventListener('click', function() { if (currentDetailId) approveDetail(currentDetailId); });
      document.getElementById('geo-btn').addEventListener('click', geoLocate);
      document.getElementById('admin-btn').addEventListener('click', function() {
        if (isAdmin) { var p = document.getElementById('mod-panel'); if (p.classList.contains('open')) closeModPanel(); else openModPanel(); }
        else toggleAdmin();
      });
      document.getElementById('mod-close').addEventListener('click', closeModPanel);
      document.getElementById('input-photo').addEventListener('change', function() {
        var f = this.files[0]; if (f) { var r = new FileReader(); r.onload = function(e) { document.getElementById('photo-preview').innerHTML = '<img src="' + e.target.result + '">'; }; r.readAsDataURL(f); }
      });
      document.querySelectorAll('.filter-btn').forEach(function(b) { b.addEventListener('click', function() { setFilter(b.dataset.filter); }); });
      document.addEventListener('keydown', function(e) { if (e.key === 'Escape') { closeDetail(); closeModPanel(); if (isAddingMode) closeAddForm(); } });
    }

    // PWA ‚Äî —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è Service Worker
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js').catch(function(e) { console.log('SW skip:', e); });
    }

    initMap();
    initEvents();
    loadDetails().then(function() {
      renderMarkers();
      updateBadge();
      document.getElementById('loading').classList.add('hidden');
    });
  </script>
</body>
</html>
