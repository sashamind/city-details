<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>textula — детали города</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#ffffff">
  <link rel="icon" type="image/png" href="favicon.png" sizes="32x32">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="textula">
  <link rel="apple-touch-icon" href="icon-192.png">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <script src="https://unpkg.com/@lottiefiles/lottie-player@2.0.8/dist/lottie-player.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bodymovin/5.12.2/lottie.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@300;400;500&family=Source+Serif+4:ital,wght@0,400;0,600;0,700;1,400&display=swap');
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Source Serif 4', Georgia, serif; background: #fff; color: #000; overflow: hidden; }
    #map { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 1; }
   .leaflet-tile { filter: grayscale(1) contrast(1.8) brightness(1.1); }
    .leaflet-control-attribution { font-family: 'IBM Plex Mono', monospace !important; font-size: 9px !important; opacity: 0.3; background: rgba(255,255,255,0.8) !important; }
    .leaflet-control-zoom { border: none !important; box-shadow: none !important; }
    .leaflet-control-zoom a { background: #fff !important; color: #000 !important; border: 1px solid #000 !important; border-radius: 0 !important; width: 28px !important; height: 28px !important; line-height: 28px !important; font-size: 14px !important; font-family: 'IBM Plex Mono', monospace !important; }
    .leaflet-control-zoom a:hover { background: #000 !important; color: #fff !important; }
    .leaflet-control-zoom-in { border-bottom: none !important; }
    .site-header { position: fixed; top: 0; left: 0; right: 0; z-index: 900; background: #fff; border-bottom: 1px solid #000; padding: 12px 20px; display: flex; justify-content: space-between; align-items: baseline; }
    .site-header h1 { font-family: 'Source Serif 4', Georgia, serif; font-weight: 700; font-size: 16px; letter-spacing: -0.02em; color: #000; }
    .site-header h1 span { font-weight: 400; font-style: italic; color: #666; }
    .header-right { display: flex; gap: 16px; align-items: center; }
    .header-btn { background: none; border: none; font-family: 'IBM Plex Mono', monospace; font-size: 12px; color: #000; cursor: pointer; padding: 4px 0; border-bottom: 1px solid transparent; transition: border-color 0.2s; }
    .header-btn:hover { border-bottom-color: #000; }
    .header-btn.active { border-bottom-color: #000; }
    .search-bar { position: fixed; top: 45px; left: 0; right: 0; z-index: 890; background: #fff; border-bottom: 1px solid #000; display: flex; align-items: center; padding: 0 16px; height: 40px; }
    .search-icon { font-size: 16px; color: #999; margin-right: 8px; flex-shrink: 0; }
    .search-input { flex: 1; border: none; outline: none; font-family: 'IBM Plex Mono', monospace; font-size: 12px; color: #000; background: transparent; padding: 8px 0; }
    .search-input::placeholder { color: #bbb; }
    .search-clear { background: none; border: none; font-size: 18px; color: #999; cursor: pointer; padding: 0 4px; font-family: 'IBM Plex Mono', monospace; transition: color 0.15s; }
    .search-clear:hover { color: #000; }
    .search-clear.hidden { display: none; }
    .search-results { position: absolute; top: 40px; left: 0; right: 0; background: #fff; border-bottom: 1px solid #000; max-height: 280px; overflow-y: auto; z-index: 891; }
    .search-results.hidden { display: none; }
    .search-result-item { display: flex; align-items: center; gap: 12px; padding: 10px 16px; cursor: pointer; border-bottom: 1px solid #eee; transition: background 0.1s; }
    .search-result-item:last-child { border-bottom: none; }
    .search-result-item:hover { background: #f5f5f5; }
    .search-result-photo { width: 40px; height: 40px; object-fit: cover; border: 1px solid #000; flex-shrink: 0; }
    .search-result-nophoto { width: 40px; height: 40px; background: #f0f0f0; border: 1px solid #ddd; display: flex; align-items: center; justify-content: center; font-size: 14px; color: #ccc; flex-shrink: 0; }
    .search-result-info { flex: 1; min-width: 0; }
    .search-result-title { font-family: 'IBM Plex Mono', monospace; font-size: 12px; font-weight: 500; color: #000; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .search-result-title mark { background: #000; color: #fff; padding: 0 2px; }
    .search-result-meta { font-family: 'IBM Plex Mono', monospace; font-size: 10px; color: #999; margin-top: 2px; }
    .search-no-results { padding: 20px 16px; text-align: center; font-family: 'IBM Plex Mono', monospace; font-size: 11px; color: #999; }
    .search-count { padding: 6px 16px; font-family: 'IBM Plex Mono', monospace; font-size: 10px; color: #999; border-bottom: 1px solid #eee; }
    .filters-bar { position: fixed; top: 85px; left: 0; right: 0; z-index: 880; background: #fff; border-bottom: 1px solid #000; display: flex; overflow-x: auto; scrollbar-width: none; }
    .filters-bar::-webkit-scrollbar { display: none; }
    .filter-btn { padding: 11px 20px 9px 20px; border: none; border-right: 1px solid #000; background: #fff; color: #666; font-family: 'IBM Plex Mono', monospace; font-size: 11px; text-transform: uppercase; letter-spacing: 0.05em; cursor: pointer; transition: all 0.15s; white-space: nowrap; flex-shrink: 0; line-height: 1; }
    .filter-btn:last-child { border-right: none; }
    .filter-btn:hover { color: #000; }
    .filter-btn.active { background: #000; color: #fff; }
    .dot-marker { display: flex; align-items: center; gap: 6px; cursor: pointer; white-space: nowrap; transition: transform 0.15s ease, opacity 0.15s ease; transform-origin: left center; }
    .dot-marker .dot { width: 8px; height: 8px; background: #000; border-radius: 50%; flex-shrink: 0; transition: transform 0.15s ease; }
    .dot-marker .label { font-family: 'IBM Plex Mono', monospace; font-size: 10px; color: #000; letter-spacing: 0.02em; opacity: 0.7; transition: opacity 0.15s ease, font-size 0.15s ease; max-width: 120px; overflow: hidden; text-overflow: ellipsis; }
    .dot-marker:hover .dot { transform: scale(1.8); }
    .dot-marker:hover .label { opacity: 1; }
    .dot-marker.pending { opacity: 0.35; }
    .dot-marker.pending .dot { border: 1.5px dashed #000; background: transparent; }
    .dot-marker.active-marker .dot { background: #000; transform: scale(2); box-shadow: 0 0 0 3px rgba(0,0,0,0.15); }
    .dot-marker.active-marker .label { opacity: 1; font-weight: 500; }
    .dot-marker.prox-1 { transform: scale(1.4); }
    .dot-marker.prox-1 .label { opacity: 1; font-size: 12px; }
    .dot-marker.prox-2 { transform: scale(1.2); }
    .dot-marker.prox-2 .label { opacity: 0.9; }
    .dot-marker.prox-3 { transform: scale(1.05); }
    .dot-marker.prox-3 .label { opacity: 0.8; }
    .marker-cluster-small, .marker-cluster-medium, .marker-cluster-large { background: rgba(0,0,0,0.08) !important; }
    .marker-cluster-small div, .marker-cluster-medium div, .marker-cluster-large div { background: #000 !important; color: #fff !important; font-family: 'IBM Plex Mono', monospace !important; font-size: 12px !important; font-weight: 500 !important; width: 32px !important; height: 32px !important; margin-left: 4px !important; margin-top: 4px !important; border-radius: 50% !important; display: flex !important; align-items: center !important; justify-content: center !important; }
    .marker-cluster { background: rgba(0,0,0,0.06) !important; border-radius: 50% !important; }
    .temp-marker { width: 16px; height: 16px; background: #000; border: 3px solid #fff; box-shadow: 0 0 0 2px #000; animation: blink 1s ease infinite; }
    @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
    .user-marker { width: 14px; height: 14px; border-radius: 50%; background: #000; border: 3px solid #fff; box-shadow: 0 0 0 1px #000; }
    .panel { position: fixed; bottom: 0; left: 0; right: 0; background: #fff; border-top: 1px solid #000; z-index: 950; max-height: 70vh; overflow-y: auto; transform: translateY(0); transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
    .panel.hidden { transform: translateY(100%); pointer-events: none; }
    .panel-toolbar { display: flex; align-items: center; justify-content: space-between; padding: 0; border-bottom: 1px solid #000; height: 44px; }
    .panel-toolbar-left { display: flex; align-items: center; height: 100%; }
    .panel-toolbar-right { display: flex; align-items: center; height: 100%; }
    .nav-btn { width: 44px; height: 44px; background: #fff; border: none; border-right: 1px solid #000; color: #000; font-size: 16px; cursor: pointer; font-family: 'IBM Plex Mono', monospace; display: flex; align-items: center; justify-content: center; transition: all 0.15s; }
    .nav-btn:hover { background: #000; color: #fff; }
    .nav-btn:disabled { opacity: 0.15; cursor: default; background: #fff; color: #000; }
    .panel-counter { padding: 0 16px; font-family: 'IBM Plex Mono', monospace; font-size: 11px; color: #666; letter-spacing: 0.05em; }
    .close-btn { width: 44px; height: 44px; background: #fff; border: none; border-left: 1px solid #000; color: #000; font-size: 18px; cursor: pointer; font-family: 'IBM Plex Mono', monospace; display: flex; align-items: center; justify-content: center; transition: all 0.15s; }
    .close-btn:hover { background: #000; color: #fff; }
    .panel-content { display: flex; gap: 0; }
    #detail-photo { width: 320px; max-height: 400px; object-fit: contain; flex-shrink: 0; background: #f5f5f5; border-right: 1px solid #000; }
    .detail-info { padding: 24px; display: flex; flex-direction: column; gap: 12px; flex: 1; }
    .detail-info h2 { font-family: 'Source Serif 4', Georgia, serif; font-weight: 700; font-size: 24px; color: #000; letter-spacing: -0.02em; line-height: 1.2; }
    .detail-info p { font-family: 'Source Serif 4', Georgia, serif; color: #333; line-height: 1.7; font-size: 15px; }
    .detail-meta { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
    .category-tag { display: inline-block; padding: 3px 10px; font-size: 10px; font-family: 'IBM Plex Mono', monospace; text-transform: uppercase; letter-spacing: 0.08em; border: 1px solid #000; color: #000; }
    .status-tag { display: inline-block; padding: 3px 10px; font-size: 10px; font-family: 'IBM Plex Mono', monospace; text-transform: uppercase; letter-spacing: 0.05em; }
    .status-tag.approved { background: #000; color: #fff; }
    .status-tag.pending { background: #fff; color: #000; border: 1px dashed #000; }
    .detail-sub { font-size: 11px; color: #999; font-family: 'IBM Plex Mono', monospace; }
    .detail-actions { display: flex; gap: 8px; margin-top: 8px; }
    .btn-approve, .btn-delete { padding: 8px 16px; font-size: 12px; font-family: 'IBM Plex Mono', monospace; cursor: pointer; transition: all 0.15s; text-transform: uppercase; letter-spacing: 0.05em; }
    .btn-approve { background: #000; color: #fff; border: 1px solid #000; }
    .btn-approve:hover { background: #333; }
    .btn-delete { background: #fff; color: #000; border: 1px solid #000; }
    .btn-delete:hover { background: #000; color: #fff; }
    .admin-only { display: none; }
    body.admin-mode .admin-only { display: flex; }
    .add-button { position: fixed; bottom: 20px; right: 20px; z-index: 960; width: 48px; height: 48px; background: #000; border: none; color: #fff; font-size: 28px; font-family: 'IBM Plex Mono', monospace; cursor: pointer; transition: all 0.15s; display: flex; align-items: center; justify-content: center; }
    .add-button:hover { transform: translate(-2px, -2px); box-shadow: 3px 3px 0 rgba(0,0,0,0.2); }
    .add-button.hidden { display: none; }
    .geo-button { position: fixed; bottom: 76px; right: 20px; z-index: 960; width: 48px; height: 48px; background: #fff; border: 1px solid #000; color: #000; font-size: 18px; cursor: pointer; transition: all 0.15s; display: flex; align-items: center; justify-content: center; }
    .geo-button:hover { background: #000; color: #fff; }
    .geo-button.locating { animation: geoBlink 0.6s ease infinite; }
    @keyframes geoBlink { 0%,100% { background: #fff; } 50% { background: #000; color: #fff; } }
    .map-hint { position: fixed; bottom: 76px; left: 50%; transform: translateX(-50%); background: #000; color: #fff; padding: 8px 20px; font-family: 'IBM Plex Mono', monospace; font-size: 12px; z-index: 960; display: none; border: none; }
    .map-hint.visible { display: block; }
    .add-panel { position: fixed; top: 0; right: 0; width: 380px; height: 100vh; background: #fff; border-left: 1px solid #000; z-index: 950; overflow-y: auto; padding: 24px; transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
    .add-panel.open { transform: translateX(0); }
    .add-panel h2 { font-family: 'Source Serif 4', Georgia, serif; font-weight: 700; font-size: 20px; margin-bottom: 20px; letter-spacing: -0.02em; }
    .status-box { font-family: 'IBM Plex Mono', monospace; font-size: 12px; padding: 10px 14px; margin-bottom: 20px; border: 1px solid #000; }
    .status-waiting { color: #666; border-style: dashed; }
    .status-ready { color: #000; background: #f0f0f0; }
    .form-field { margin-bottom: 16px; }
    .form-field label { display: block; font-family: 'IBM Plex Mono', monospace; font-size: 10px; text-transform: uppercase; letter-spacing: 0.1em; color: #666; margin-bottom: 6px; }
    .form-field input[type="text"], .form-field textarea, .form-field select { width: 100%; padding: 10px 12px; background: #fff; border: 1px solid #000; font-family: 'Source Serif 4', Georgia, serif; font-size: 14px; color: #000; outline: none; }
    .form-field input:focus, .form-field textarea:focus, .form-field select:focus { box-shadow: 3px 3px 0 #000; }
    .form-field textarea { height: 80px; resize: vertical; }
    .form-field select { font-family: 'IBM Plex Mono', monospace; font-size: 12px; }
    .category-checkboxes { display: flex; flex-wrap: wrap; gap: 4px; }
.cat-check { display: inline-flex; align-items: center; gap: 4px; padding: 5px 10px; border: 1px solid #000; font-family: 'IBM Plex Mono', monospace; font-size: 11px; cursor: pointer; transition: all 0.15s; user-select: none; }
.cat-check:hover { background: #f0f0f0; }
.cat-check input { display: none; }
.cat-check.checked { background: #000; color: #fff; }
    .form-field input[type="file"] { font-family: 'IBM Plex Mono', monospace; font-size: 12px; color: #666; }
    .photo-preview { margin-top: 8px; }
    .photo-preview img { max-width: 100%; max-height: 120px; border: 1px solid #000; }
    .form-actions { display: flex; gap: 0; margin-top: 24px; }
    .btn-primary { flex: 1; padding: 12px; background: #000; color: #fff; border: 1px solid #000; font-family: 'IBM Plex Mono', monospace; font-size: 12px; text-transform: uppercase; letter-spacing: 0.08em; cursor: pointer; }
    .btn-primary:hover { background: #333; }
    .btn-secondary { flex: 1; padding: 12px; background: #fff; color: #000; border: 1px solid #000; border-left: none; font-family: 'IBM Plex Mono', monospace; font-size: 12px; text-transform: uppercase; letter-spacing: 0.08em; cursor: pointer; }
    .btn-secondary:hover { background: #f0f0f0; }
    .mod-panel { position: fixed; top: 0; right: 0; width: 420px; height: 100vh; background: #fff; border-left: 1px solid #000; z-index: 970; overflow-y: auto; padding: 24px; transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
    .mod-panel.open { transform: translateX(0); }
    .mod-panel h2 { font-family: 'Source Serif 4', Georgia, serif; font-weight: 700; font-size: 20px; margin-bottom: 4px; }
    .mod-subtitle { color: #666; font-family: 'IBM Plex Mono', monospace; font-size: 12px; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 1px solid #000; }
    .mod-close { position: absolute; top: 16px; right: 16px; background: none; border: none; color: #000; font-size: 24px; cursor: pointer; font-family: 'IBM Plex Mono', monospace; }
    .mod-close:hover { opacity: 0.5; }
    .mod-card { border: 1px solid #000; padding: 16px; margin-bottom: 12px; }
    .mod-card-photo { width: 100%; height: 160px; object-fit: cover; margin-bottom: 12px; border: 1px solid #000; }
    .mod-card h3 { font-family: 'Source Serif 4', Georgia, serif; font-weight: 600; font-size: 16px; margin-bottom: 4px; }
    .mod-card p { color: #333; font-size: 13px; line-height: 1.6; margin-bottom: 8px; }
    .mod-card-cat { font-size: 10px; color: #666; font-family: 'IBM Plex Mono', monospace; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 12px; }
    .mod-card-actions { display: flex; gap: 0; }
    .mod-card-actions button { flex: 1; padding: 8px; font-size: 11px; cursor: pointer; font-family: 'IBM Plex Mono', monospace; text-transform: uppercase; letter-spacing: 0.05em; }
    .mod-btn-approve { background: #000; color: #fff; border: 1px solid #000; }
    .mod-btn-approve:hover { background: #333; }
    .mod-btn-reject { background: #fff; color: #000; border: 1px solid #000; border-left: none; }
    .mod-btn-reject:hover { background: #f0f0f0; }
    .mod-empty { text-align: center; padding: 40px 20px; color: #999; font-family: 'IBM Plex Mono', monospace; }
    .mod-empty-icon { font-size: 32px; margin-bottom: 12px; }
    .badge { position: absolute; top: -6px; right: -6px; background: #000; color: #fff; font-size: 9px; font-weight: 500; min-width: 16px; height: 16px; display: flex; align-items: center; justify-content: center; font-family: 'IBM Plex Mono', monospace; border: 1px solid #fff; }
    .badge.hidden { display: none; }
    .loading-overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: #fff; z-index: 9999; display: flex; align-items: center; justify-content: center; font-family: 'IBM Plex Mono', monospace; color: #000; font-size: 13px; letter-spacing: 0.05em; }
    .loading-overlay.hidden { display: none; }
    .marker-preview { position: fixed; z-index: 940; pointer-events: none; background: #fff; border: 1px solid #000; padding: 0; opacity: 0; transform: translateY(4px); transition: opacity 0.15s ease, transform 0.15s ease; max-width: 200px; }
    .marker-preview.visible { opacity: 1; transform: translateY(0); }
    .marker-preview img { display: block; width: 200px; height: 140px; object-fit: cover; }
    .marker-preview .preview-title { padding: 6px 10px; font-family: 'IBM Plex Mono', monospace; font-size: 10px; color: #000; border-top: 1px solid #000; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .marker-preview .preview-no-photo { width: 200px; height: 60px; display: flex; align-items: center; justify-content: center; color: #ccc; font-family: 'IBM Plex Mono', monospace; font-size: 10px; }
    .onboarding { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: #fff; z-index: 10000; display: flex; align-items: center; justify-content: center; flex-direction: column; transition: opacity 0.6s ease, transform 0.6s ease; }
    .onboarding.hiding { opacity: 0; transform: scale(1.02); pointer-events: none; }
    .onboarding.hidden { display: none; }
    .onboarding-content { text-align: center; max-width: 420px; padding: 0 24px; }
    .onboarding-title { font-family: 'Source Serif 4', Georgia, serif; font-weight: 700; font-size: 32px; letter-spacing: -0.03em; color: #000; margin-bottom: 4px; }
    .onboarding-title span { font-weight: 400; font-style: italic; color: #666; }
    .onboarding-desc { font-family: 'Source Serif 4', Georgia, serif; font-size: 16px; color: #666; line-height: 1.6; margin-top: 16px; margin-bottom: 32px; }
    .onboarding-dots { display: flex; gap: 8px; justify-content: center; margin-bottom: 32px; }
    .onboarding-dot { width: 6px; height: 6px; background: #000; border-radius: 50%; animation: onbDot 1.4s ease infinite; }
    .onboarding-dot:nth-child(2) { animation-delay: 0.2s; }
    .onboarding-dot:nth-child(3) { animation-delay: 0.4s; }
    @keyframes onbDot { 0%, 100% { opacity: 0.15; transform: scale(1); } 50% { opacity: 1; transform: scale(1.5); } }
    .onboarding-enter { background: #000; color: #fff; border: none; padding: 14px 40px; font-family: 'IBM Plex Mono', monospace; font-size: 12px; text-transform: uppercase; letter-spacing: 0.1em; cursor: pointer; transition: all 0.15s; }
    .onboarding-enter:hover { background: #333; }
    .onboarding-terms {
  margin-top: 16px;
  font-family: 'IBM Plex Mono', monospace;
  font-size: 9px;
  color: #bbb;
  letter-spacing: 0.03em;
}
.onboarding-terms a {
  color: #999;
  text-decoration: underline;
}
.onboarding-terms a:hover {
  color: #000;
}
    .onboarding-hint { margin-top: 24px; font-family: 'IBM Plex Mono', monospace; font-size: 10px; color: #ccc; letter-spacing: 0.05em; }
    .form-agree { margin-top: 8px; }
.agree-label { display: flex; gap: 8px; align-items: flex-start; font-family: 'IBM Plex Mono', monospace; font-size: 10px; color: #666; line-height: 1.5; cursor: pointer; }
.agree-label input[type="checkbox"] { margin-top: 2px; flex-shrink: 0; accent-color: #000; }
.terms-link { color: #000; text-decoration: underline; }
.terms-link:hover { text-decoration: none; }

/* Модальное окно условий */
.terms-modal { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.5); z-index: 10001; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
.terms-modal.open { opacity: 1; pointer-events: auto; }
.terms-body { background: #fff; border: 1px solid #000; max-width: 520px; width: 90%; max-height: 80vh; overflow-y: auto; padding: 32px; position: relative; }
.terms-body h2 { font-family: 'Source Serif 4', Georgia, serif; font-size: 20px; font-weight: 700; margin-bottom: 16px; }
.terms-body p, .terms-body li { font-family: 'IBM Plex Mono', monospace; font-size: 11px; color: #333; line-height: 1.8; margin-bottom: 12px; }
.terms-body ul { padding-left: 20px; margin-bottom: 12px; }
.terms-body .terms-date { font-size: 10px; color: #999; margin-top: 20px; }
.terms-close { position: absolute; top: 12px; right: 12px; background: none; border: none; font-size: 24px; cursor: pointer; font-family: 'IBM Plex Mono', monospace; color: #000; }
.terms-close:hover { opacity: 0.5; }
    .plus-icon {
    display: inline-flex;
    justify-content: center;
    align-items: center;
    width: 22px;
    height: 22px;
    background: transparent;    /* Прозрачный фон */
    border: 1.5px solid #000;   /* Чёрная рамка */
    color: #000;                /* Чёрный плюс */
    border-radius: 0;           /* Острые углы */
    font-weight: 600;
    font-size: 16px;
    line-height: 1;
    vertical-align: middle;     /* Выравнивание по тексту */
    margin: 0 5px;
    padding-bottom: 2px;        /* Оптическая центровка */
    box-sizing: border-box;
}
    .search-connect { display: flex; align-items: center; justify-content: center; gap: 6px; width: 100%; padding: 10px 16px; background: #fff; border: none; border-top: 1px solid #000; font-family: 'IBM Plex Mono', monospace; font-size: 11px;    text-transform: uppercase; letter-spacing: 0.05em; cursor: pointer; color: #000; transition: all 0.15s; }
    .search-connect:hover { background: #000; color: #fff; }
    .search-connect.active { background: #000; color: #fff; }
    .search-connect-icon { font-size: 14px; }

    /* === NOTES === */
    .notes-section { margin-top: 16px; border-top: 1px solid #eee; padding-top: 16px; }
    .notes-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
    .notes-title { font-family: 'IBM Plex Mono', monospace; font-size: 11px; text-transform: uppercase; letter-spacing: 0.08em; color: #999; }
    .notes-count { font-family: 'IBM Plex Mono', monospace; font-size: 10px; color: #ccc; }
    .btn-add-note { background: none; border: 1px solid #000; padding: 4px 12px; font-family: 'IBM Plex Mono', monospace; font-size: 10px; text-transform: uppercase; letter-spacing: 0.05em; cursor: pointer; color: #000; transition: all 0.15s; }
    .btn-add-note:hover { background: #000; color: #fff; }
    .note-item { padding: 12px 0; border-bottom: 1px solid #f0f0f0; }
    .note-item:last-child { border-bottom: none; }
    .note-text { font-family: 'Source Serif 4', Georgia, serif; font-size: 14px; color: #333; line-height: 1.6; }
    .note-meta { font-family: 'IBM Plex Mono', monospace; font-size: 10px; color: #bbb; margin-top: 6px; }
    .note-status { display: inline-block; padding: 1px 6px; font-size: 9px; font-family: 'IBM Plex Mono', monospace; text-transform: uppercase; margin-left: 8px; }
    .note-status.pending { border: 1px dashed #999; color: #999; }
    .note-form { margin-top: 12px; padding: 16px; border: 1px solid #000; display: none; }
    .note-form.open { display: block; }
    .note-form textarea { width: 100%; height: 70px; padding: 10px; border: 1px solid #ddd; font-family: 'Source Serif 4', Georgia, serif; font-size: 14px; color: #000; outline: none; resize: vertical; }
    .note-form textarea:focus { border-color: #000; }
    .note-form-row { display: flex; gap: 0; margin-top: 8px; }
    .note-form-author { flex: 1; padding: 8px 10px; border: 1px solid #ddd; border-right: none; font-family: 'IBM Plex Mono', monospace; font-size: 12px; outline: none; }
    .note-form-author:focus { border-color: #000; }
    .note-form-submit { padding: 8px 16px; background: #000; color: #fff; border: 1px solid #000; font-family: 'IBM Plex Mono', monospace; font-size: 11px; text-transform: uppercase; letter-spacing: 0.05em; cursor: pointer; }
    .note-form-submit:hover { background: #333; }
    .note-form-cancel { padding: 8px 16px; background: #fff; color: #000; border: 1px solid #000; border-left: none; font-family: 'IBM Plex Mono', monospace; font-size: 11px; text-transform: uppercase; letter-spacing: 0.05em; cursor: pointer; }
    .note-form-cancel:hover { background: #f0f0f0; }
    .note-admin-actions { display: inline-flex; gap: 4px; margin-left: 8px; }
    .note-admin-btn { background: none; border: none; font-size: 12px; cursor: pointer; opacity: 0.4; transition: opacity 0.15s; padding: 0 2px; }
    .note-admin-btn:hover { opacity: 1; }
    .notes-empty { font-family: 'IBM Plex Mono', monospace; font-size: 11px; color: #ccc; padding: 8px 0; }
    .mod-section-title { font-family: 'IBM Plex Mono', monospace; font-size: 10px; text-transform: uppercase; letter-spacing: 0.1em; color: #999; margin: 24px 0 12px; padding-bottom: 8px; border-bottom: 1px solid #eee; }
    .mod-note-card { border: 1px dashed #000; padding: 14px; margin-bottom: 10px; }
    .mod-note-text { font-family: 'Source Serif 4', Georgia, serif; font-size: 13px; line-height: 1.6; color: #333; margin-bottom: 6px; }
    .mod-note-meta { font-family: 'IBM Plex Mono', monospace; font-size: 10px; color: #999; margin-bottom: 10px; }
    .mod-note-actions { display: flex; gap: 0; }
    .mod-note-actions button { flex: 1; padding: 6px; font-size: 10px; cursor: pointer; font-family: 'IBM Plex Mono', monospace; text-transform: uppercase; letter-spacing: 0.05em; }

    @media (max-width: 768px) {
      .marker-preview { display: none !important; }
      .site-header { padding: 10px 16px; }
      .site-header h1 { font-size: 14px; }
      .search-bar { top: 41px; height: 36px; padding: 0 12px; }
      .search-input { font-size: 16px; }
      .search-results { top: 36px; }
      .filters-bar { top: auto; bottom: 16px; left: 50%; right: auto; transform: translateX(-50%); border: 1px solid #000; max-width: 94vw; overflow-x: auto; z-index: 900; }
      .filter-btn:last-child { border-right: none; }
      .panel-content { flex-direction: column; }
      #detail-photo { width: 100%; max-height: 240px; border-right: none; border-bottom: 1px solid #000; }
      .detail-info { padding: 16px; }
      .detail-info h2 { font-size: 20px; }
      .add-button { bottom: 64px; right: 16px; width: 44px; height: 44px; }
      .geo-button { bottom: 116px; right: 16px; width: 44px; height: 44px; }
      .add-panel { width: 100%; height: auto; max-height: 120px; top: auto; bottom: 0; right: 0; border-left: none; border-top: 1px solid #000; transform: translateY(100%); padding: 16px 20px; overflow: hidden; transition: max-height 0.4s cubic-bezier(0.16, 1, 0.3, 1), transform 0.3s; }
      .add-panel.open { transform: translateY(0); max-height: 120px; }
      .add-panel.open.expanded { max-height: 80vh; overflow-y: auto; }
      .add-panel .form-field, .add-panel .form-actions { display: none; }
      .add-panel.expanded .form-field, .add-panel.expanded .form-actions { display: block; }
      .mod-panel { width: 100%; height: 70vh; top: auto; bottom: 0; right: 0; border-left: none; border-top: 1px solid #000; transform: translateY(100%); }
      .mod-panel.open { transform: translateY(0); }
      .map-hint { bottom: 130px; font-size: 11px; }
      .dot-marker .label { max-width: 80px; font-size: 9px; }
      .onboarding-title { font-size: 24px; }
      .onboarding-desc { font-size: 14px; }
    }
  </style>
</head>
<body>
  <div id="onboarding" class="onboarding">
  <div class="onboarding-content">
  <!-- Статичная часть (не меняется) -->
  <div id="lottie-container" style="width: 98px; height: 30px; margin: 0 auto 24px;"></div>
  <div class="onboarding-dots">
    <div class="onboarding-dot"></div>
    <div class="onboarding-dot"></div>
    <div class="onboarding-dot"></div>
  </div>
  <h1 class="onboarding-title"><span>— детали города</span></h1>

  <!-- Сменяемая часть -->
  <div id="step-1">
    <p class="onboarding-desc">Проект визуального исследования города через детали. Фактуры стен, старинные вывески, узоры решёток — переплетение того, мимо чего мы проходим каждый день.</p>
    <button id="btn-next" class="onboarding-enter">Далее &rarr;</button>
  </div>

  <div id="step-2" style="display: none; opacity: 0; transition: opacity 0.5s ease;">
  <p class="onboarding-desc">Изучай детали города и добавляй свои визуальные находки <span class="plus-icon">+</span>. Скоро они появятся на карте!</p>
  <button id="btn-finish" class="onboarding-enter">Исследовать</button>
  <p class="onboarding-terms">Нажимая «Исследовать», вы принимаете <a href="#" id="onb-terms-link" class="terms-link">условия</a> и <a href="privacy.html" target="_blank" class="terms-link">политику конфиденциальности</a></p>
</div>
  
  <p class="onboarding-hint">или нажмите любую клавишу</p>
</div>
</div>
  <div id="loading" class="loading-overlay hidden">Загрузка...</div>
  <div id="map"></div>
  <div id="marker-preview" class="marker-preview"></div>
  <div class="site-header">
    <h1>textula <span>— детали города</span></h1>
        <div class="header-right">
      <button id="admin-btn" class="header-btn" style="position:relative;">⚙ Админ<span id="pending-badge" class="badge hidden">0</span></button>
    </div>
  </div>
  <div id="search-bar" class="search-bar">
    <span class="search-icon">⌕</span>
    <input type="text" id="search-input" class="search-input" placeholder="Найти деталь...">
    <button id="search-clear" class="search-clear hidden">×</button>
    <div id="search-results" class="search-results hidden"></div>
  </div>
  <div class="filters-bar">
    <button class="filter-btn active" data-filter="all">Все</button>
    <button class="filter-btn" data-filter="texture">Текстуры</button>
    <button class="filter-btn" data-filter="sign">Знаки</button>
    <button class="filter-btn" data-filter="art">Арт</button>
    <button class="filter-btn" data-filter="detail">Детали</button>
    <button class="filter-btn" data-filter="other">Другое</button>
  </div>
  <div id="detail-panel" class="panel hidden">
    <div class="panel-toolbar">
      <div class="panel-toolbar-left">
        <button id="nav-prev" class="nav-btn">←</button>
        <button id="nav-next" class="nav-btn">→</button>
        <span id="panel-counter" class="panel-counter"></span>
      </div>
      <div class="panel-toolbar-right">
        <button id="close-panel" class="close-btn">×</button>
      </div>
    </div>
    <div class="panel-content">
      <img id="detail-photo" src="" alt="">
      <div class="detail-info">
        <h2 id="detail-title"></h2>
        <p id="detail-description"></p>
        <div class="detail-meta">
          <span id="detail-category" class="category-tag"></span>
          <span id="detail-status" class="status-tag"></span>
        </div>
        <div id="detail-sub" class="detail-sub"></div>
        <div class="detail-actions admin-only">
          <button id="btn-approve-detail" class="btn-approve">✓ Одобрить</button>
          <button id="btn-delete-detail" class="btn-delete">✕ Удалить</button>
        </div>
        <!-- NOTES SECTION -->
        <div id="notes-section" class="notes-section">
          <div class="notes-header">
            <span class="notes-title">Описания <span id="notes-count" class="notes-count"></span></span>
            <button id="btn-add-note" class="btn-add-note">+ Добавить</button>
          </div>
          <div id="note-form" class="note-form">
            <textarea id="note-text" placeholder="Ваше описание или наблюдение..."></textarea>
            <div class="note-form-row">
              <input type="text" id="note-author" class="note-form-author" placeholder="Ваше имя">
              <button id="note-submit" class="note-form-submit">Отправить</button>
              <button id="note-cancel" class="note-form-cancel">×</button>
            </div>
          </div>
          <div id="notes-list"></div>
        </div>
      </div>
    </div>
  </div>
  <button id="add-btn" class="add-button">+</button>
  <button id="geo-float" class="geo-button">◎</button>
  <div id="map-hint" class="map-hint">← кликните на карту</div>
  <div id="add-panel" class="add-panel">
    <h2>Новая деталь</h2>
    <div id="status-box" class="status-box status-waiting">← Кликните на карту чтобы выбрать место</div>
    <div class="form-field"><label>Фото</label><input type="file" id="input-photo" accept="image/*"><div id="photo-preview" class="photo-preview"></div></div>
    <div class="form-field"><label>Название</label><input type="text" id="input-title" placeholder="Старинная решётка на Металлистов"></div>
    <div class="form-field"><label>Описание</label><textarea id="input-description" placeholder="Что вы заметили?"></textarea></div>
    <div class="form-field"><label>Автор</label><input type="text" id="input-author" placeholder="Ваше имя"></div>
    <div class="form-field">
  <label>Категории</label>
  <div id="input-categories" class="category-checkboxes">
    <label class="cat-check"><input type="checkbox" value="texture"> Текстура</label>
    <label class="cat-check"><input type="checkbox" value="sign"> Знак</label>
    <label class="cat-check"><input type="checkbox" value="art"> Арт</label>
    <label class="cat-check"><input type="checkbox" value="detail"> Деталь</label>
    <label class="cat-check"><input type="checkbox" value="other"> Другое</label>
  </div>
</div>
        <div class="form-field form-agree">
  <label class="agree-label">
    <input type="checkbox" id="input-agree">
    <span>Я подтверждаю, что фото принадлежит мне, и даю согласие на его размещение. <a href="#" id="terms-link" class="terms-link">Условия</a> · <a href="privacy.html" target="_blank" class="terms-link">Конфиденциальность</a></span>
  </label>
</div>
    <div class="form-actions">
      <button id="submit-detail" class="btn-primary">Отправить</button>
      <button id="cancel-form" class="btn-secondary">Отмена</button>
    </div>
  </div>
  <div id="mod-panel" class="mod-panel">
    <button id="mod-close" class="mod-close">×</button>
    <h2>Модерация</h2>
    <p class="mod-subtitle">Новые заявки от пользователей</p>
    <div id="mod-list"></div>
  </div>
 <div id="terms-modal" class="terms-modal">
    <div class="terms-body">
      <button id="terms-close" class="terms-close">×</button>
      <h2>Условия использования</h2>
      <p>Размещая материалы на сайте textula, вы соглашаетесь со следующими условиями:</p>
      <ul>
        <li><strong>Авторские права.</strong> Загружая фотографию, вы подтверждаете, что являетесь автором данного изображения или имеете право на его использование.</li>
        <li><strong>Лицензия.</strong> Вы предоставляете проекту textula неисключительное, безвозмездное право использовать, отображать и хранить загруженные материалы в рамках проекта.</li>
        <li><strong>Контент.</strong> Запрещается загружать материалы, нарушающие законодательство РФ, содержащие персональные данные третьих лиц без их согласия, а также оскорбительный или неприемлемый контент.</li>
        <li><strong>Модерация.</strong> Администрация оставляет за собой право удалить любой материал без объяснения причин.</li>
        <li><strong>Удаление.</strong> Вы можете запросить удаление своих материалов, связавшись с администрацией проекта.</li>
        <li><strong>Ответственность.</strong> Проект не несёт ответственности за содержание пользовательских материалов.</li>
      </ul>
      <p>Пользуясь сайтом, вы также соглашаетесь с тем, что данные о геолокации точек являются публичными и видны всем посетителям.</p>
      <p style="margin-top:16px;"><a href="privacy.html" target="_blank" class="terms-link">Политика конфиденциальности →</a></p>
      <div class="terms-date">Последнее обновление: июнь 2025</div>
    </div>
  </div>
  <script>
    var SUPABASE_URL = 'https://yzvigrtnwmkwkpmqmdzh.supabase.co';
    var SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl6dmlncnRud21rd2twbXFtZHpoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA4MjQ0MTEsImV4cCI6MjA4NjQwMDQxMX0.Ky1RV2Lqd5TF4LzpQXJPuk2_HGLrXaKe6bBRm-niJ3c';
    var ADMIN_CODE = 'tula2024';
    var isAdmin = false;
    var CATEGORIES = {
      texture: { label: 'Текстура', color: '#000' },
      sign: { label: 'Знак', color: '#000' },
      art: { label: 'Арт', color: '#000' },
      detail: { label: 'Деталь', color: '#000' },
      other: { label: 'Другое', color: '#000' }
    };
    var details = [], markerObjects = [], activeFilter = 'all';
    var isAddingMode = false, pendingCoords = null, tempMarker = null, currentDetailId = null, map;
    var userMarker = null, mouseLatLng = null, proximityRAF = null, clusterGroup = null;
    var gallery = [], galleryIndex = 0, previewTimeout = null;
    var isTouchDevice = ('ontouchstart' in window);
    var searchQuery = '';
    var connectLine = null;
    var lastSearchMatches = [];
    var currentNotes = [];
    var pendingNotes = [];
    var EMAILJS_PUBLIC_KEY = 'Vvny9RUBFyNXNw6nn';
var EMAILJS_SERVICE_ID = 'service_textula';
var EMAILJS_TEMPLATE_ID = 'template_0d0q9ed';

function sendEmailNotification(detail) {
  if (isAdmin) return;
  emailjs.init(EMAILJS_PUBLIC_KEY);
  emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, {
    title: detail.title,
    author: detail.author || 'Аноним',
    category: detail.category,
    lat: detail.lat,
    lng: detail.lng,
    description: detail.description || '—'
  }).then(function() {
    console.log('Email sent');
  }).catch(function(err) {
    console.log('Email error:', err);
  });
}

    function supaFetch(path, options) {
      var opts = options || {};
      var headers = { 'apikey': SUPABASE_KEY, 'Authorization': 'Bearer ' + SUPABASE_KEY, 'Content-Type': 'application/json', 'Prefer': opts.prefer || 'return=representation' };
      return fetch(SUPABASE_URL + '/rest/v1/' + path, { method: opts.method || 'GET', headers: headers, body: opts.body ? JSON.stringify(opts.body) : undefined }).then(function(r) { return r.json(); });
    }

    function loadDetails() {
      var query = isAdmin ? 'details?select=*&order=created_at.desc' : 'details?select=*&status=eq.approved&order=created_at.desc';
      return supaFetch(query).then(function(data) {
        if (Array.isArray(data)) {
          details = data.map(function(d) { return { id: d.id, title: d.title, description: d.description || '', category: d.category, lat: d.lat, lng: d.lng, photo: d.photo_url || '', status: d.status, author: d.author || '', created_at: d.created_at || '' }; });
        }
        updateBadge();
      }).catch(function(e) { console.error('Load error:', e); });
    }

    function loadAllForAdmin() {
      return supaFetch('details?select=*&order=created_at.desc').then(function(data) {
        if (Array.isArray(data)) {
          details = data.map(function(d) { return { id: d.id, title: d.title, description: d.description || '', category: d.category, lat: d.lat, lng: d.lng, photo: d.photo_url || '', status: d.status, author: d.author || '', created_at: d.created_at || '' }; });
        }
        updateBadge();
      }).catch(function(e) { console.error('Load error:', e); });
    }

    /* === NOTES FUNCTIONS === */
    function loadNotes(detailId) {
      var query = isAdmin
        ? 'notes?detail_id=eq.' + detailId + '&order=created_at.asc'
        : 'notes?detail_id=eq.' + detailId + '&status=eq.approved&order=created_at.asc';
      return supaFetch(query).then(function(data) {
        if (Array.isArray(data)) { currentNotes = data; }
        else { currentNotes = []; }
        renderNotes();
      }).catch(function() { currentNotes = []; renderNotes(); });
    }

    function loadPendingNotes() {
      return supaFetch('notes?status=eq.pending&order=created_at.asc').then(function(data) {
        if (Array.isArray(data)) { pendingNotes = data; }
        else { pendingNotes = []; }
      }).catch(function() { pendingNotes = []; });
    }

    function renderNotes() {
      var list = document.getElementById('notes-list');
      var countEl = document.getElementById('notes-count');
      var approved = currentNotes.filter(function(n) { return n.status === 'approved'; });
      var pending = isAdmin ? currentNotes.filter(function(n) { return n.status === 'pending'; }) : [];
      var total = approved.length + pending.length;
      countEl.textContent = total > 0 ? '(' + total + ')' : '';

      if (total === 0) {
        list.innerHTML = '<div class="notes-empty">Пока нет описаний. Будьте первым!</div>';
        return;
      }

      var html = '';
      approved.forEach(function(n) {
        html += '<div class="note-item">';
        html += '<div class="note-text">' + escapeHtml(n.text) + '</div>';
        html += '<div class="note-meta">' + (n.author || 'Аноним') + ' · ' + formatDate(n.created_at);
        if (isAdmin) {
          html += '<span class="note-admin-actions">';
          html += '<button class="note-admin-btn" onclick="deleteNote(\'' + n.id + '\')" title="Удалить">✕</button>';
          html += '</span>';
        }
        html += '</div></div>';
      });

      pending.forEach(function(n) {
        html += '<div class="note-item" style="opacity:0.5;border-left:2px dashed #000;padding-left:10px;">';
        html += '<div class="note-text">' + escapeHtml(n.text) + '</div>';
        html += '<div class="note-meta">' + (n.author || 'Аноним') + ' · ' + formatDate(n.created_at);
        html += '<span class="note-status pending">На модерации</span>';
        if (isAdmin) {
          html += '<span class="note-admin-actions">';
          html += '<button class="note-admin-btn" onclick="approveNote(\'' + n.id + '\')" title="Одобрить">✓</button>';
          html += '<button class="note-admin-btn" onclick="deleteNote(\'' + n.id + '\')" title="Удалить">✕</button>';
          html += '</span>';
        }
        html += '</div></div>';
      });

      list.innerHTML = html;
    }

    function escapeHtml(str) {
      return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
    }

    function submitNote() {
      var text = document.getElementById('note-text').value.trim();
      var author = document.getElementById('note-author').value.trim() || 'Аноним';
      if (!text) { alert('Введите описание'); return; }
      if (!currentDetailId) return;
      if (!isAdmin && isReservedName(author)) { alert('Это имя зарезервировано'); return; }

      var btn = document.getElementById('note-submit');
      btn.disabled = true; btn.textContent = '...';

      var row = { detail_id: currentDetailId, text: text, author: author, status: isAdmin ? 'approved' : 'pending' };
      supaFetch('notes', { method: 'POST', body: row }).then(function(data) {
        if (data && data[0]) { currentNotes.push(data[0]); }
        renderNotes();
        document.getElementById('note-text').value = '';
        document.getElementById('note-author').value = '';
        document.getElementById('note-form').classList.remove('open');
        btn.disabled = false; btn.textContent = 'Отправить';
        if (!isAdmin) alert('Спасибо! Описание отправлено на модерацию.');
        updateBadge();
      }).catch(function() {
        alert('Ошибка отправки');
        btn.disabled = false; btn.textContent = 'Отправить';
      });
    }

    function approveNote(id) {
      supaFetch('notes?id=eq.' + id, { method: 'PATCH', body: { status: 'approved' } }).then(function() {
        var n = currentNotes.find(function(x) { return x.id === id; });
        if (n) n.status = 'approved';
        renderNotes();
        updateBadge();
        renderModList();
      });
    }

    function deleteNote(id) {
      if (!confirm('Удалить описание?')) return;
      supaFetch('notes?id=eq.' + id, { method: 'DELETE', prefer: 'return=minimal' }).then(function() {
        currentNotes = currentNotes.filter(function(n) { return n.id !== id; });
        pendingNotes = pendingNotes.filter(function(n) { return n.id !== id; });
        renderNotes();
        updateBadge();
        renderModList();
      });
    }

    function uploadPhoto(file) {
      var fileName = Date.now() + '_' + file.name.replace(/[^a-zA-Z0-9._-]/g, '');
      return fetch(SUPABASE_URL + '/storage/v1/object/photos/' + fileName, { method: 'POST', headers: { 'apikey': SUPABASE_KEY, 'Authorization': 'Bearer ' + SUPABASE_KEY, 'Content-Type': file.type }, body: file }).then(function(r) { if (r.ok) return SUPABASE_URL + '/storage/v1/object/public/photos/' + fileName; throw new Error('Upload failed'); });
    }

    function formatDate(dateStr) {
      if (!dateStr) return '';
      var d = new Date(dateStr);
      var months = ['янв','фев','мар','апр','май','июн','июл','авг','сен','окт','ноя','дек'];
      return d.getDate() + ' ' + months[d.getMonth()] + ' ' + d.getFullYear();
    }

    function getPendingCount() {
      var detailsPending = details.filter(function(d) { return d.status === 'pending'; }).length;
      var notesPending = pendingNotes.length;
      return detailsPending + notesPending;
    }

    function updateBadge() {
      if (isAdmin) {
        loadPendingNotes().then(function() {
          var c = getPendingCount();
          var b = document.getElementById('pending-badge');
          if (c > 0) { b.textContent = c; b.classList.remove('hidden'); } else { b.classList.add('hidden'); }
        });
      } else {
        var c = details.filter(function(d) { return d.status === 'pending'; }).length;
        var b = document.getElementById('pending-badge');
        if (c > 0) { b.textContent = c; b.classList.remove('hidden'); } else { b.classList.add('hidden'); }
      }
    }

    function buildGallery() {
      var bounds = map.getBounds();
      return details.filter(function(d) {
        if (!isAdmin && d.status !== 'approved') return false;
        if (activeFilter !== 'all') {
  var cats = (d.category || '').split(',');
  if (cats.indexOf(activeFilter) === -1) return false;
}
        if (!bounds.contains([d.lat, d.lng])) return false;
        return true;
      }).sort(function(a, b) {
        var dy = b.lat - a.lat;
        if (Math.abs(dy) > 0.0005) return dy;
        return a.lng - b.lng;
      });
    }

    function navigateDetail(direction) {
      if (gallery.length <= 1) return;
      galleryIndex += direction;
      if (galleryIndex < 0) galleryIndex = gallery.length - 1;
      if (galleryIndex >= gallery.length) galleryIndex = 0;
      showGalleryItem(galleryIndex);
    }

    function showGalleryItem(idx) {
      galleryIndex = idx;
      var d = gallery[idx];
      currentDetailId = d.id;
      var photo = document.getElementById('detail-photo');
      photo.src = ''; photo.style.display = 'none';
      if (d.photo) { photo.style.display = ''; photo.src = d.photo; }
      document.getElementById('detail-title').textContent = d.title;
      document.getElementById('detail-description').textContent = d.description;
      var catLabels = (d.category || 'other').split(',').map(function(c) {
  return (CATEGORIES[c.trim()] || CATEGORIES.other).label;
});
document.getElementById('detail-category').textContent = catLabels.join(' · ');
      var st = document.getElementById('detail-status');
      if (d.status === 'pending') { st.textContent = 'На модерации'; st.className = 'status-tag pending'; st.style.display = ''; }
      else if (isAdmin) { st.textContent = 'Одобрено'; st.className = 'status-tag approved'; st.style.display = ''; }
      else { st.style.display = 'none'; }
      var subParts = [];
      if (d.author) subParts.push(d.author);
      if (d.created_at) subParts.push(formatDate(d.created_at));
      document.getElementById('detail-sub').textContent = subParts.join(' · ');
      document.getElementById('btn-approve-detail').style.display = (d.status === 'pending') ? '' : 'none';
      document.getElementById('panel-counter').textContent = (idx + 1) + ' из ' + gallery.length;
      var hasMany = gallery.length > 1;
      document.getElementById('nav-prev').disabled = !hasMany;
      document.getElementById('nav-next').disabled = !hasMany;
      highlightActiveMarker(d.id);
      // Load notes for this detail
      document.getElementById('note-form').classList.remove('open');
      loadNotes(d.id);
    }

    function highlightActiveMarker(activeId) {
      markerObjects.forEach(function(item) {
        var el = item.marker.getElement(); if (!el) return;
        var div = el.querySelector('.dot-marker'); if (!div) return;
        if (item.detail.id === activeId) div.classList.add('active-marker');
        else div.classList.remove('active-marker');
      });
    }

    function showPreview(detail, markerEl) {
      if (isTouchDevice) return;
      var prev = document.getElementById('marker-preview');
            var rect = markerEl.getBoundingClientRect();
      var html = '';
      if (detail.photo) { html += '<img src="' + detail.photo + '" alt="">'; }
      else { html += '<div class="preview-no-photo">нет фото</div>'; }
      html += '<div class="preview-title">' + detail.title + '</div>';
      prev.innerHTML = html;
      var left = rect.left;
      prev.style.left = left + 'px';
      prev.style.bottom = (window.innerHeight - rect.top + 10) + 'px';
      prev.style.top = 'auto';
      if (left + 200 > window.innerWidth) prev.style.left = (window.innerWidth - 210) + 'px';
      prev.classList.add('visible');
    }

    function hidePreview() { var el = document.getElementById('marker-preview'); if (el) el.classList.remove('visible'); }

    function geoLocate() {
      if (!navigator.geolocation) { alert('Геолокация не поддерживается'); return; }
      var btn = document.getElementById('geo-float');
      btn.classList.add('locating');
      navigator.geolocation.getCurrentPosition(function(pos) {
        var lat = pos.coords.latitude, lng = pos.coords.longitude;
        map.flyTo([lat, lng], 17, { duration: 1.2 });
        userMarker = L.marker([lat, lng], {
          icon: L.divIcon({ html: '<div class="user-marker"></div>', className: '', iconSize: [14,14], iconAnchor: [7,7] })
        }).addTo(map);
        btn.classList.remove('locating');
      }, function(err) {
        btn.classList.remove('locating');
        if (err.code === 1) alert('Разрешите доступ к геолокации');
        else alert('Не удалось определить местоположение');
      }, { enableHighAccuracy: true, timeout: 10000 });
    }

    function initMap() {
      map = L.map('map', { center: [54.1935, 37.6180], zoom: 15, zoomControl: false });
      L.control.zoom({ position: 'bottomleft' }).addTo(map);
      L.tileLayer('https://stamen-tiles.a.ssl.fastly.net/toner/{z}/{x}/{y}.png', {
  attribution: '&copy; OpenStreetMap &copy; Stamen Design', maxZoom: 19 }).addTo(map);
      map.on('mousemove', function(e) { mouseLatLng = e.latlng; if (!proximityRAF) proximityRAF = requestAnimationFrame(updateProximity); });
      map.on('click', function(e) {
  if (!isAddingMode) return;
  pendingCoords = { lat: e.latlng.lat, lng: e.latlng.lng };
  if (tempMarker) map.removeLayer(tempMarker);
  tempMarker = L.marker([e.latlng.lat, e.latlng.lng], { icon: L.divIcon({ html: '<div class="temp-marker"></div>', className: '', iconSize: [16,16], iconAnchor: [8,8] }) }).addTo(map);
  var box = document.getElementById('status-box');
  box.className = 'status-box status-ready';
  box.textContent = '✓ ' + e.latlng.lat.toFixed(4) + ', ' + e.latlng.lng.toFixed(4);
  document.getElementById('add-panel').classList.add('expanded');
  document.getElementById('map-hint').classList.remove('visible');
});
    }

    function updateProximity() {
      proximityRAF = null;
      if (!mouseLatLng) return;
      var mousePoint = map.latLngToContainerPoint(mouseLatLng);
      markerObjects.forEach(function(item) {
        var el = item.marker.getElement(); if (!el) return;
        var div = el.querySelector('.dot-marker'); if (!div) return;
        var markerPoint = map.latLngToContainerPoint([item.detail.lat, item.detail.lng]);
        var dx = mousePoint.x - markerPoint.x, dy = mousePoint.y - markerPoint.y;
        var dist = Math.sqrt(dx * dx + dy * dy);
        div.classList.remove('prox-1', 'prox-2', 'prox-3');
        if (dist < 60) div.classList.add('prox-1');
        else if (dist < 120) div.classList.add('prox-2');
        else if (dist < 200) div.classList.add('prox-3');
      });
    }

    function renderMarkers() {
      if (clusterGroup) map.removeLayer(clusterGroup);
      clusterGroup = L.markerClusterGroup({
        maxClusterRadius: 50, spiderfyOnMaxZoom: true, showCoverageOnHover: false, zoomToBoundsOnClick: true,
        iconCreateFunction: function(cluster) {
          var count = cluster.getChildCount();
          return L.divIcon({ html: '<div class="marker-cluster-inner">' + count + '</div>', className: 'marker-cluster marker-cluster-' + (count < 5 ? 'small' : count < 15 ? 'medium' : 'large'), iconSize: [40, 40] });
        }
      });
      markerObjects = [];
      details.filter(function(d) {
        if (!isAdmin && d.status !== 'approved') return false;
        if (activeFilter !== 'all') {
  var cats = (d.category || '').split(',');
  if (cats.indexOf(activeFilter) === -1) return false;
}
        return true;
      }).forEach(function(detail) {
        var cls = (detail.status === 'pending') ? ' pending' : '';
        var title = detail.title || '';
        if (title.length > 18) title = title.substring(0, 18) + '…';
        var h = '<div class="dot-marker' + cls + '"><div class="dot"></div><div class="label">' + title + '</div></div>';
        var marker = L.marker([detail.lat, detail.lng], { icon: L.divIcon({ html: h, className: '', iconSize: [150, 20], iconAnchor: [4, 10] }) });
        marker.on('click', function() { if (isAddingMode) return; hidePreview(); openDetail(detail); });
        (function(det) {
          marker.on('mouseover', function() { if (isAddingMode || isTouchDevice) return; previewTimeout = setTimeout(function() { var el = marker.getElement(); if (el) showPreview(det, el); }, 300); });
          marker.on('mouseout', function() { clearTimeout(previewTimeout); hidePreview(); });
        })(detail);
        clusterGroup.addLayer(marker);
        markerObjects.push({ marker: marker, detail: detail });
      });
      map.addLayer(clusterGroup);
    }

    function doSearch(query) {
      searchQuery = query.toLowerCase().trim();
      var clearBtn = document.getElementById('search-clear');
      var resultsEl = document.getElementById('search-results');
      if (!searchQuery) { clearBtn.classList.add('hidden'); resultsEl.classList.add('hidden'); resultsEl.innerHTML = ''; lastSearchMatches = []; removeConnectLine(); return; }
      clearBtn.classList.remove('hidden');
      var matches = details.filter(function(d) {
        if (!isAdmin && d.status !== 'approved') return false;
        var hay = (d.title + ' ' + d.description + ' ' + d.author).toLowerCase();
        return hay.indexOf(searchQuery) !== -1;
      });
      lastSearchMatches = matches;
      if (matches.length === 0) { resultsEl.innerHTML = '<div class="search-no-results">Ничего не найдено</div>'; resultsEl.classList.remove('hidden'); removeConnectLine(); return; }
      var html = '<div class="search-count">Найдено: ' + matches.length + '</div>';
      var show = matches.slice(0, 7);
      show.forEach(function(d) {
        var title = d.title;
        var re = new RegExp('(' + searchQuery.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + ')', 'gi');
        var highlighted = title.replace(re, '<mark>$1</mark>');
        var catLabels = (d.category || 'other').split(',').map(function(c) {
  return (CATEGORIES[c.trim()] || CATEGORIES.other).label;
});
var cat = { label: catLabels.join(' · ') };
        html += '<div class="search-result-item" data-id="' + d.id + '">';
        if (d.photo) { html += '<img class="search-result-photo" src="' + d.photo + '" alt="">'; }
        else { html += '<div class="search-result-nophoto">●</div>'; }
        html += '<div class="search-result-info"><div class="search-result-title">' + highlighted + '</div>';
        html += '<div class="search-result-meta">' + cat.label + (d.author ? ' · ' + d.author : '') + '</div></div></div>';
      });
      if (matches.length >= 2) {
        var isActive = connectLine ? ' active' : '';
        html += '<button class="search-connect' + isActive + '" id="search-connect-btn"><span class="search-connect-icon">⟋</span> ' + (connectLine ? 'Убрать связь' : 'Связать · ' + matches.length + ' точек') + '</button>';
      }
      resultsEl.innerHTML = html;
      resultsEl.classList.remove('hidden');
      resultsEl.querySelectorAll('.search-result-item').forEach(function(el) {
        el.addEventListener('click', function() {
          var id = el.getAttribute('data-id');
          var d = details.find(function(x) { return x.id === id; });
          if (d) { resultsEl.classList.add('hidden'); map.flyTo([d.lat, d.lng], 17, { duration: 0.8 }); setTimeout(function() { openDetail(d); }, 900); }
        });
      });
      var connectBtn = document.getElementById('search-connect-btn');
      if (connectBtn) {
        connectBtn.addEventListener('click', function(e) {
          e.stopPropagation();
          if (connectLine) { removeConnectLine(); doSearch(document.getElementById('search-input').value); }
          else { drawConnectLine(matches); doSearch(document.getElementById('search-input').value); }
        });
      }
    }

    function drawConnectLine(matches) {
      removeConnectLine();
      if (matches.length < 2) return;
      lastSearchMatches = matches;
      updateConnectLines();
      map.on('moveend', updateConnectLines);
      map.on('zoomend', updateConnectLines);
    }

    function updateConnectLines() {
      if (!lastSearchMatches.length) return;
      if (connectLine) { map.removeLayer(connectLine); connectLine = null; }
      var bounds = map.getBounds();
      var visible = lastSearchMatches.filter(function(d) { return bounds.contains([d.lat, d.lng]); });
      if (visible.length < 2) return;
      var lines = [];
      for (var i = 0; i < visible.length; i++) {
        for (var j = i + 1; j < visible.length; j++) {
          lines.push([[visible[i].lat, visible[i].lng], [visible[j].lat, visible[j].lng]]);
        }
      }
      connectLine = L.layerGroup(lines.map(function(pair) {
        return L.polyline(pair, { color: '#000', weight: 1, opacity: 0.4 });
      })).addTo(map);
    }

    function removeConnectLine() {
      map.off('moveend', updateConnectLines);
      map.off('zoomend', updateConnectLines);
      if (connectLine) { map.removeLayer(connectLine); connectLine = null; }
    }

    function clearSearch() { document.getElementById('search-input').value = ''; lastSearchMatches = []; removeConnectLine(); doSearch(''); document.getElementById('search-input').focus(); }

    function openDetail(d) {
  gallery = buildGallery();
  galleryIndex = 0;
  for (var i = 0; i < gallery.length; i++) { if (gallery[i].id === d.id) { galleryIndex = i; break; } }
  showGalleryItem(galleryIndex);
  document.getElementById('detail-panel').classList.remove('hidden');
  document.getElementById('add-btn').style.display = 'none';
  document.getElementById('geo-float').style.display = 'none';
}

    function closeDetail() {
  document.getElementById('detail-panel').classList.add('hidden');
  currentDetailId = null; gallery = []; galleryIndex = 0;
  highlightActiveMarker(null);
  currentNotes = [];
  document.getElementById('add-btn').style.display = '';
  document.getElementById('geo-float').style.display = '';
}

    function deleteDetail() {
      if (!currentDetailId || !confirm('Удалить?')) return;
      supaFetch('details?id=eq.' + currentDetailId, { method: 'DELETE', prefer: 'return=minimal' }).then(function() {
        details = details.filter(function(d) { return d.id !== currentDetailId; });
        renderMarkers(); closeDetail(); updateBadge(); renderModList();
      });
    }

    function approveDetail(id) {
      supaFetch('details?id=eq.' + id, { method: 'PATCH', body: { status: 'approved' } }).then(function() {
        var d = details.find(function(x) { return x.id === id; });
        if (d) { d.status = 'approved'; renderMarkers(); updateBadge(); renderModList(); if (currentDetailId === id) { gallery = buildGallery(); showGalleryItem(galleryIndex); } }
      });
    }

    function rejectDetail(id) {
      if (!confirm('Удалить заявку?')) return;
      supaFetch('details?id=eq.' + id, { method: 'DELETE', prefer: 'return=minimal' }).then(function() {
        details = details.filter(function(d) { return d.id !== id; });
        renderMarkers(); updateBadge(); renderModList();
        if (currentDetailId === id) closeDetail();
      });
    }

    function openAddForm() {
  isAddingMode = true;
  closeDetail(); closeModPanel();
  document.getElementById('add-panel').classList.add('open');
  document.getElementById('add-btn').classList.add('hidden');
  document.getElementById('geo-float').style.display = 'none';
  document.getElementById('map-hint').classList.add('visible');
  document.getElementById('map').style.cursor = 'crosshair';
}

    function closeAddForm() {
  isAddingMode = false; pendingCoords = null;
  if (tempMarker) { map.removeLayer(tempMarker); tempMarker = null; }
  document.getElementById('add-panel').classList.remove('open');
  document.getElementById('add-panel').classList.remove('expanded');
  document.getElementById('add-btn').classList.remove('hidden');
  document.getElementById('geo-float').style.display = '';
  document.getElementById('map-hint').classList.remove('visible');
  document.getElementById('map').style.cursor = '';
  document.getElementById('input-title').value = '';
  document.getElementById('input-description').value = '';
  document.getElementById('input-author').value = '';
  clearCategoryCheckboxes();
  document.getElementById('input-photo').value = '';
  document.getElementById('photo-preview').innerHTML = '';
  document.getElementById('input-agree').checked = false;
  var box = document.getElementById('status-box');
  box.className = 'status-box status-waiting';
  box.textContent = '← Кликните на карту чтобы выбрать место';
}
function getSelectedCategories() {
  var checks = document.querySelectorAll('#input-categories input:checked');
  var cats = [];
  checks.forEach(function(c) { cats.push(c.value); });
  return cats;
}

function clearCategoryCheckboxes() {
  document.querySelectorAll('#input-categories input').forEach(function(c) {
    c.checked = false;
  });
  document.querySelectorAll('.cat-check').forEach(function(l) {
    l.classList.remove('checked');
  });
}
function isReservedName(name) {
  var blocked = ['админ', 'администратор', 'admin', 'administrator', 'модератор', 'moderator', 'сашь'];
  var lower = name.toLowerCase().trim();
  for (var i = 0; i < blocked.length; i++) {
    if (lower === blocked[i] || lower.indexOf(blocked[i]) !== -1) return true;
  }
  return false;
}
    function submitDetail() {
      var title = document.getElementById('input-title').value.trim();
      var desc = document.getElementById('input-description').value.trim();
      var author = document.getElementById('input-author').value.trim();
      var cats = getSelectedCategories();
if (cats.length === 0) { alert('Выберите хотя бы одну категорию'); return; }
var cat = cats.join(',');
      var fileInput = document.getElementById('input-photo');
      if (!isAdmin && isReservedName(author)) { alert('Это имя зарезервировано'); return; }
      var agreed = document.getElementById('input-agree').checked;
if (!agreed) { alert('Пожалуйста, подтвердите согласие с условиями'); return; }
      if (!title) { alert('Укажите название'); return; }
      if (!pendingCoords) { alert('Кликните на карту'); return; }
      var btn = document.getElementById('submit-detail');
      btn.disabled = true; btn.textContent = 'Отправка...';
      function saveToDb(photoUrl) {
        var row = { title: title, description: desc, category: cat, lat: pendingCoords.lat, lng: pendingCoords.lng, photo_url: photoUrl || '', status: isAdmin ? 'approved' : 'pending', author: author || 'Аноним' };
        supaFetch('details', { method: 'POST', body: row }).then(function(data) {
          if (data && data[0]) {
            var d = data[0];
            details.push({ id: d.id, title: d.title, description: d.description || '', category: d.category, lat: d.lat, lng: d.lng, photo: d.photo_url || '', status: d.status, author: d.author || '', created_at: d.created_at || '' });
          }
          sendEmailNotification({ title: title, author: author || 'Аноним', category: cat, lat: pendingCoords.lat, lng: pendingCoords.lng, description: desc });
          renderMarkers(); closeAddForm(); updateBadge();
          btn.disabled = false; btn.textContent = 'Отправить';
          if (!isAdmin) alert('Спасибо! Деталь отправлена на модерацию.');
        }).catch(function(e) { alert('Ошибка'); btn.disabled = false; btn.textContent = 'Отправить'; });
      }
      if (fileInput.files && fileInput.files[0]) { uploadPhoto(fileInput.files[0]).then(function(url) { saveToDb(url); }).catch(function() { saveToDb(''); }); }
      else { saveToDb(''); }
    }

    function setFilter(f) {
      activeFilter = f;
      document.querySelectorAll('.filter-btn').forEach(function(b) { b.classList.toggle('active', b.dataset.filter === f); });
      renderMarkers();
    }

    function toggleAdmin() {
      if (isAdmin) { isAdmin = false; document.body.classList.remove('admin-mode'); document.getElementById('admin-btn').classList.remove('active'); closeModPanel(); loadDetails().then(function() { renderMarkers(); }); return; }
      var code = prompt('Код администратора:');
      if (code === ADMIN_CODE) { isAdmin = true; document.body.classList.add('admin-mode'); document.getElementById('admin-btn').classList.add('active'); loadAllForAdmin().then(function() { renderMarkers(); updateBadge(); if (getPendingCount() > 0) openModPanel(); }); }
      else if (code !== null) alert('Неверный код');
    }

    function openModPanel() { document.getElementById('mod-panel').classList.add('open'); closeAddForm(); closeDetail(); renderModList(); }
    function closeModPanel() { document.getElementById('mod-panel').classList.remove('open'); }

    function renderModList() {
      var list = document.getElementById('mod-list');
      var pendingDetails = details.filter(function(d) { return d.status === 'pending'; });

      var exitBtn = '<button onclick="toggleAdmin()" style="width:100%;margin-top:20px;padding:12px;background:none;border:1px solid #000;font-size:11px;cursor:pointer;font-family:IBM Plex Mono,monospace;text-transform:uppercase;letter-spacing:0.05em;">Выйти из админки</button>';

      var html = '';

      // Details section
      if (pendingDetails.length > 0) {
        html += '<div class="mod-section-title">Точки (' + pendingDetails.length + ')</div>';
        pendingDetails.forEach(function(d) {
          var catLabels = (d.category || 'other').split(',').map(function(c) {
  return (CATEGORIES[c.trim()] || CATEGORIES.other).label;
});
var cat = { label: catLabels.join(' · ') };
          html += '<div class="mod-card">';
          if (d.photo) html += '<img class="mod-card-photo" src="' + d.photo + '" alt="">';
          html += '<h3>' + d.title + '</h3>';
          if (d.description) html += '<p>' + d.description + '</p>';
          html += '<div class="mod-card-cat">' + cat.label + ' · ' + (d.author || 'Аноним') + ' · ' + formatDate(d.created_at) + '</div>';
          html += '<div class="mod-card-actions"><button class="mod-btn-approve" onclick="approveDetail(\'' + d.id + '\')">✓ Одобрить</button><button class="mod-btn-reject" onclick="rejectDetail(\'' + d.id + '\')">✕ Отклонить</button></div></div>';
        });
      }

      // Notes section
      if (pendingNotes.length > 0) {
        html += '<div class="mod-section-title">Описания (' + pendingNotes.length + ')</div>';
        pendingNotes.forEach(function(n) {
          var parentDetail = details.find(function(d) { return d.id === n.detail_id; });
          var parentTitle = parentDetail ? parentDetail.title : 'Неизвестная точка';
          html += '<div class="mod-note-card">';
          html += '<div class="mod-note-text">' + escapeHtml(n.text) + '</div>';
          html += '<div class="mod-note-meta">К точке: ' + escapeHtml(parentTitle) + ' · ' + (n.author || 'Аноним') + ' · ' + formatDate(n.created_at) + '</div>';
          html += '<div class="mod-note-actions"><button class="mod-btn-approve" onclick="approveNote(\'' + n.id + '\')">✓ Одобрить</button><button class="mod-btn-reject" onclick="deleteNote(\'' + n.id + '\')">✕ Отклонить</button></div></div>';
        });
      }

      if (pendingDetails.length === 0 && pendingNotes.length === 0) {
        html = '<div class="mod-empty"><div class="mod-empty-icon">✓</div><p>Нет заявок</p></div>';
      }

      list.innerHTML = html + exitBtn;
    }

    function initEvents() {
      document.getElementById('close-panel').addEventListener('click', closeDetail);
      document.getElementById('nav-prev').addEventListener('click', function() { navigateDetail(-1); });
      document.getElementById('nav-next').addEventListener('click', function() { navigateDetail(1); });
      document.getElementById('add-btn').addEventListener('click', openAddForm);
      document.getElementById('cancel-form').addEventListener('click', closeAddForm);
      document.getElementById('submit-detail').addEventListener('click', submitDetail);
      document.getElementById('btn-delete-detail').addEventListener('click', deleteDetail);
      document.getElementById('btn-approve-detail').addEventListener('click', function() { if (currentDetailId) approveDetail(currentDetailId); });
      document.getElementById('geo-float').addEventListener('click', geoLocate);
      document.getElementById('admin-btn').addEventListener('click', function() {
        if (isAdmin) { var p = document.getElementById('mod-panel'); if (p.classList.contains('open')) closeModPanel(); else openModPanel(); }
        else toggleAdmin();
      });
      document.getElementById('mod-close').addEventListener('click', closeModPanel);
      document.getElementById('input-photo').addEventListener('change', function() {
        var f = this.files[0]; if (f) { var r = new FileReader(); r.onload = function(e) { document.getElementById('photo-preview').innerHTML = '<img src="' + e.target.result + '">'; }; r.readAsDataURL(f); }
      });
      // Category checkboxes toggle
document.querySelectorAll('.cat-check').forEach(function(label) {
  label.addEventListener('click', function() {
    var cb = label.querySelector('input');
    cb.checked = !cb.checked;
    label.classList.toggle('checked', cb.checked);
  });
});
      document.querySelectorAll('.filter-btn').forEach(function(b) {
        b.addEventListener('click', function() { setFilter(b.dataset.filter); });
      });

      // Search
      var searchInput = document.getElementById('search-input');
      var searchTimer = null;
      searchInput.addEventListener('input', function() {
        clearTimeout(searchTimer);
        searchTimer = setTimeout(function() { doSearch(searchInput.value); }, 200);
      });
      document.getElementById('search-clear').addEventListener('click', clearSearch);
      document.addEventListener('click', function(e) {
        var bar = document.getElementById('search-bar');
        if (!bar.contains(e.target)) document.getElementById('search-results').classList.add('hidden');
      });
      searchInput.addEventListener('focus', function() { if (searchInput.value.trim()) doSearch(searchInput.value); });

      // Notes
      document.getElementById('btn-add-note').addEventListener('click', function() {
        var form = document.getElementById('note-form');
        form.classList.toggle('open');
        if (form.classList.contains('open')) { document.getElementById('note-text').focus(); }
      });
      document.getElementById('note-submit').addEventListener('click', submitNote);
      document.getElementById('note-cancel').addEventListener('click', function() {
        document.getElementById('note-form').classList.remove('open');
        document.getElementById('note-text').value = '';
        document.getElementById('note-author').value = '';
      });
            // Terms modal
      document.getElementById('terms-link').addEventListener('click', function(e) {
        e.preventDefault();
        document.getElementById('terms-modal').classList.add('open');
      });
      document.getElementById('terms-close').addEventListener('click', function() {
        document.getElementById('terms-modal').classList.remove('open');
      });
      document.getElementById('terms-modal').addEventListener('click', function(e) {
        if (e.target === this) this.classList.remove('open');
      });

      // Terms link from onboarding
      var onbTermsLink = document.getElementById('onb-terms-link');
      if (onbTermsLink) {
        onbTermsLink.addEventListener('click', function(e) {
          e.preventDefault();
          document.getElementById('terms-modal').classList.add('open');
        });
      }

      // Keyboard
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') { closeDetail(); closeModPanel(); if (isAddingMode) closeAddForm(); clearSearch(); document.getElementById('terms-modal').classList.remove('open'); }
        if (e.key === 'ArrowLeft' && gallery.length > 0) navigateDetail(-1);
        if (e.key === 'ArrowRight' && gallery.length > 0) navigateDetail(1);
      });
    }

    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js').catch(function(e) { console.log('SW skip:', e); });
    }

    var mapReady = false;
    var ONBOARDING_DAYS = 7;
    var onboardingSeen = localStorage.getItem('textula_onboarding');

    function startApp() {
      initMap();
      initEvents();
      loadDetails().then(function() {
        renderMarkers();
        mapReady = true;
        document.getElementById('loading').classList.add('hidden');
      });
    }

    function dismissOnboarding() {
      var onb = document.getElementById('onboarding');
      if (onb.classList.contains('hidden')) return;
      localStorage.setItem('textula_onboarding', Date.now().toString());
      document.getElementById('loading').classList.remove('hidden');
      onb.style.transition = 'opacity 0.5s ease';
      onb.style.opacity = '0';
      setTimeout(function() {
        onb.style.display = 'none';
        onb.classList.add('hidden');
        startApp();
      }, 500);
    }

    if (onboardingSeen && (Date.now() - parseInt(onboardingSeen)) < ONBOARDING_DAYS * 24 * 60 * 60 * 1000) {
  document.getElementById('onboarding').style.display = 'none';
  document.getElementById('onboarding').classList.add('hidden');
  document.getElementById('loading').classList.remove('hidden');
  startApp();
} else {
  // 1. Запуск Lottie (с паузой 3 сек)
  var lottieAnim = lottie.loadAnimation({
    container: document.getElementById('lottie-container'),
    renderer: 'svg',
    loop: false,
    autoplay: false,
    path: 'textula.json'
  });

  var lottieDirection = 1;
  lottieAnim.addEventListener('complete', function() {
    setTimeout(function() {
      lottieDirection *= -1;
      lottieAnim.setDirection(lottieDirection);
      lottieAnim.play();
    }, 3000);
  });

  lottieAnim.addEventListener('DOMLoaded', function() {
    setTimeout(function() {
      lottieAnim.play();
    }, 3000);
  });

  // 2. Логика переключения шагов
  var step1 = document.getElementById('step-1');
  var step2 = document.getElementById('step-2');
  var btnNext = document.getElementById('btn-next');
  var btnFinish = document.getElementById('btn-finish');
  // Terms from onboarding
  var onbTerms = document.getElementById('onb-terms-link');
  if (onbTerms) {
    onbTerms.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      document.getElementById('terms-modal').classList.add('open');
    });
  }
  // Close terms on onboarding
  document.getElementById('terms-close').addEventListener('click', function() {
    document.getElementById('terms-modal').classList.remove('open');
  });
  document.getElementById('terms-modal').addEventListener('click', function(e) {
    if (e.target === this) this.classList.remove('open');
  });
  // Кнопка "Далее"
  btnNext.addEventListener('click', function() {
    step1.style.display = 'none';
    step2.style.display = 'block';
    // Небольшая задержка для плавного появления (fade in)
    setTimeout(function() {
        step2.style.opacity = '1';
    }, 50);
  });

  // Кнопка "Исследовать" (финиш)
  btnFinish.addEventListener('click', dismissOnboarding);

  // Клавиатура (Enter/Space тоже переключат, или закроют)
  document.addEventListener('keydown', function handler(e) {
    if (!document.getElementById('onboarding').classList.contains('hidden')) {
        // Если видим первый шаг — переключаем на второй
        if (step1.style.display !== 'none') {
            btnNext.click();
        } else {
            // Если видим второй шаг — закрываем
            dismissOnboarding();
            document.removeEventListener('keydown', handler);
        }
    }
    });
}
    </script>
</body>
</html>